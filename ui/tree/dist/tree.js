"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const treePath = require("./path");
const ops = require("./ops");
const common_1 = require("common");
function build(root) {
    function lastNode() {
        return ops.findInMainline(root, function (node) {
            return !node.children.length;
        });
    }
    function nodeAtPath(path) {
        return nodeAtPathFrom(root, path);
    }
    function nodeAtPathFrom(node, path) {
        if (path === '')
            return node;
        const child = ops.childById(node, treePath.head(path));
        return child ? nodeAtPathFrom(child, treePath.tail(path)) : node;
    }
    function nodeAtPathOrNull(path) {
        return nodeAtPathOrNullFrom(root, path);
    }
    function nodeAtPathOrNullFrom(node, path) {
        if (path === '')
            return node;
        const child = ops.childById(node, treePath.head(path));
        return child ? nodeAtPathOrNullFrom(child, treePath.tail(path)) : undefined;
    }
    function longestValidPathFrom(node, path) {
        var id = treePath.head(path);
        const child = ops.childById(node, id);
        return child ? id + longestValidPathFrom(child, treePath.tail(path)) : '';
    }
    function getCurrentNodesAfterPly(nodeList, mainline, ply) {
        var node, nodes = [];
        for (var i in nodeList) {
            node = nodeList[i];
            if (node.ply <= ply && mainline[i].id !== node.id)
                break;
            if (node.ply > ply)
                nodes.push(node);
        }
        return nodes;
    }
    ;
    function pathIsMainline(path) {
        return pathIsMainlineFrom(root, path);
    }
    function pathExists(path) {
        return !!nodeAtPathOrNull(path);
    }
    function pathIsMainlineFrom(node, path) {
        if (path === '')
            return true;
        const pathId = treePath.head(path), child = node.children[0];
        if (!child || child.id !== pathId)
            return false;
        return pathIsMainlineFrom(child, treePath.tail(path));
    }
    function pathIsForcedVariation(path) {
        return !!getNodeList(path).find(n => n.forceVariation);
    }
    function lastMainlineNodeFrom(node, path) {
        if (path === '')
            return node;
        const pathId = treePath.head(path);
        const child = node.children[0];
        if (!child || child.id !== pathId)
            return node;
        return lastMainlineNodeFrom(child, treePath.tail(path));
    }
    function getNodeList(path) {
        return ops.collect(root, function (node) {
            const id = treePath.head(path);
            if (id === '')
                return;
            path = treePath.tail(path);
            return ops.childById(node, id);
        });
    }
    function getOpening(nodeList) {
        var opening;
        nodeList.forEach(function (node) {
            opening = node.opening || opening;
        });
        return opening;
    }
    function updateAt(path, update) {
        const node = nodeAtPathOrNull(path);
        if (node) {
            update(node);
            return node;
        }
        return;
    }
    // returns new path
    function addNode(node, path) {
        const newPath = path + node.id, existing = nodeAtPathOrNull(newPath);
        if (existing) {
            ['dests', 'drops', 'clock'].forEach(key => {
                if (common_1.defined(node[key]) && !common_1.defined(existing[key]))
                    existing[key] = node[key];
            });
            return newPath;
        }
        return updateAt(path, function (parent) {
            parent.children.push(node);
        }) ? newPath : undefined;
    }
    function addNodes(nodes, path) {
        var node = nodes[0];
        if (!node)
            return path;
        const newPath = addNode(node, path);
        return newPath ? addNodes(nodes.slice(1), newPath) : undefined;
    }
    function deleteNodeAt(path) {
        ops.removeChild(parentNode(path), treePath.last(path));
    }
    function promoteAt(path, toMainline) {
        var nodes = getNodeList(path);
        for (var i = nodes.length - 2; i >= 0; i--) {
            var node = nodes[i + 1];
            var parent = nodes[i];
            if (parent.children[0].id !== node.id) {
                ops.removeChild(parent, node.id);
                parent.children.unshift(node);
                if (!toMainline)
                    break;
            }
            else if (node.forceVariation) {
                node.forceVariation = false;
                if (!toMainline)
                    break;
            }
        }
    }
    function setCommentAt(comment, path) {
        return !comment.text ? deleteCommentAt(comment.id, path) : updateAt(path, function (node) {
            node.comments = node.comments || [];
            const existing = node.comments.find(function (c) {
                return c.id === comment.id;
            });
            if (existing)
                existing.text = comment.text;
            else
                node.comments.push(comment);
        });
    }
    function deleteCommentAt(id, path) {
        return updateAt(path, function (node) {
            var comments = (node.comments || []).filter(function (c) {
                return c.id !== id;
            });
            node.comments = comments.length ? comments : undefined;
        });
    }
    function setGlyphsAt(glyphs, path) {
        return updateAt(path, function (node) {
            node.glyphs = glyphs;
        });
    }
    function parentNode(path) {
        return nodeAtPath(treePath.init(path));
    }
    function getParentClock(node, path) {
        if (!('parentClock' in node)) {
            const par = path && parentNode(path);
            if (!par)
                node.parentClock = node.clock;
            else if (!('clock' in par))
                node.parentClock = undefined;
            else
                node.parentClock = par.clock;
        }
        return node.parentClock;
    }
    return {
        root,
        lastPly() {
            return lastNode().ply;
        },
        nodeAtPath,
        getNodeList,
        longestValidPath: (path) => longestValidPathFrom(root, path),
        getOpening,
        updateAt,
        addNode,
        addNodes,
        addDests(dests, path, opening) {
            return updateAt(path, function (node) {
                node.dests = dests;
                if (opening)
                    node.opening = opening;
            });
        },
        setShapes(shapes, path) {
            return updateAt(path, function (node) {
                node.shapes = shapes;
            });
        },
        setCommentAt,
        deleteCommentAt,
        setGlyphsAt,
        setClockAt(clock, path) {
            return updateAt(path, function (node) {
                node.clock = clock;
            });
        },
        pathIsMainline,
        pathIsForcedVariation,
        lastMainlineNode(path) {
            return lastMainlineNodeFrom(root, path);
        },
        pathExists,
        deleteNodeAt,
        promoteAt,
        forceVariationAt(path, force) {
            return updateAt(path, function (node) {
                node.forceVariation = force;
            });
        },
        getCurrentNodesAfterPly,
        merge(tree) {
            ops.merge(root, tree);
        },
        removeCeval() {
            ops.updateAll(root, function (n) {
                delete n.ceval;
                delete n.threat;
            });
        },
        removeComputerVariations() {
            ops.mainlineNodeList(root).forEach(function (n) {
                n.children = n.children.filter(function (c) {
                    return !c.comp;
                });
            });
        },
        parentNode,
        getParentClock
    };
}
exports.build = build;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLDZCQUE2QjtBQUM3QixtQ0FBaUM7QUFtQ2pDLFNBQWdCLEtBQUssQ0FBQyxJQUFlO0lBRW5DLFNBQVMsUUFBUTtRQUNmLE9BQU8sR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsVUFBUyxJQUFlO1lBQ3RELE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztRQUMvQixDQUFDLENBQUUsQ0FBQztJQUNOLENBQUM7SUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFlO1FBQ2pDLE9BQU8sY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsU0FBUyxjQUFjLENBQUMsSUFBZSxFQUFFLElBQWU7UUFDdEQsSUFBSSxJQUFJLEtBQUssRUFBRTtZQUFFLE9BQU8sSUFBSSxDQUFDO1FBQzdCLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN2RCxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNuRSxDQUFDO0lBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxJQUFlO1FBQ3ZDLE9BQU8sb0JBQW9CLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCxTQUFTLG9CQUFvQixDQUFDLElBQWUsRUFBRSxJQUFlO1FBQzVELElBQUksSUFBSSxLQUFLLEVBQUU7WUFBRSxPQUFPLElBQUksQ0FBQztRQUM3QixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUks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JztcbmltcG9ydCAqIGFzIG9wcyBmcm9tICcuL29wcyc7XG5pbXBvcnQgeyBkZWZpbmVkIH0gZnJvbSAnY29tbW9uJztcblxuZXhwb3J0IHR5cGUgTWF5YmVOb2RlID0gVHJlZS5Ob2RlIHwgdW5kZWZpbmVkO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRyZWVXcmFwcGVyIHtcbiAgcm9vdDogVHJlZS5Ob2RlO1xuICBsYXN0UGx5KCk6IG51bWJlcjtcbiAgbm9kZUF0UGF0aChwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLk5vZGU7XG4gIGdldE5vZGVMaXN0KHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZVtdO1xuICBsb25nZXN0VmFsaWRQYXRoKHBhdGg6IHN0cmluZyk6IFRyZWUuUGF0aDtcbiAgZ2V0T3BlbmluZyhub2RlTGlzdDogVHJlZS5Ob2RlW10pOiBUcmVlLk9wZW5pbmcgfCB1bmRlZmluZWQ7XG4gIHVwZGF0ZUF0KHBhdGg6IFRyZWUuUGF0aCwgdXBkYXRlOiAobm9kZTogVHJlZS5Ob2RlKSA9PiB2b2lkKTogTWF5YmVOb2RlO1xuICBhZGROb2RlKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5QYXRoIHwgdW5kZWZpbmVkO1xuICBhZGROb2Rlcyhub2RlczogVHJlZS5Ob2RlW10sIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuUGF0aCB8IHVuZGVmaW5lZDtcbiAgYWRkRGVzdHMoZGVzdHM6IHN0cmluZywgcGF0aDogVHJlZS5QYXRoLCBvcGVuaW5nPzogVHJlZS5PcGVuaW5nKTogTWF5YmVOb2RlO1xuICBzZXRTaGFwZXMoc2hhcGVzOiBUcmVlLlNoYXBlW10sIHBhdGg6IFRyZWUuUGF0aCk6IE1heWJlTm9kZTtcbiAgc2V0Q29tbWVudEF0KGNvbW1lbnQ6IFRyZWUuQ29tbWVudCwgcGF0aDogVHJlZS5QYXRoKTogTWF5YmVOb2RlO1xuICBkZWxldGVDb21tZW50QXQoaWQ6IHN0cmluZywgcGF0aDogVHJlZS5QYXRoKTogTWF5YmVOb2RlO1xuICBzZXRHbHlwaHNBdChnbHlwaHM6IFRyZWUuR2x5cGhbXSwgcGF0aDogVHJlZS5QYXRoKTogTWF5YmVOb2RlO1xuICBzZXRDbG9ja0F0KGNsb2NrOiBUcmVlLkNsb2NrIHwgdW5kZWZpbmVkLCBwYXRoOiBUcmVlLlBhdGgpOiBNYXliZU5vZGU7XG4gIHBhdGhJc01haW5saW5lKHBhdGg6IFRyZWUuUGF0aCk6IGJvb2xlYW47XG4gIHBhdGhJc0ZvcmNlZFZhcmlhdGlvbihwYXRoOiBUcmVlLlBhdGgpOiBib29sZWFuO1xuICBsYXN0TWFpbmxpbmVOb2RlKHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZTtcbiAgcGF0aEV4aXN0cyhwYXRoOiBUcmVlLlBhdGgpOiBib29sZWFuO1xuICBkZWxldGVOb2RlQXQocGF0aDogVHJlZS5QYXRoKTogdm9pZDtcbiAgcHJvbW90ZUF0KHBhdGg6IFRyZWUuUGF0aCwgdG9NYWlubGluZTogYm9vbGVhbik6IHZvaWQ7XG4gIGZvcmNlVmFyaWF0aW9uQXQocGF0aDogVHJlZS5QYXRoLCBmb3JjZTogYm9vbGVhbik6IE1heWJlTm9kZTtcbiAgZ2V0Q3VycmVudE5vZGVzQWZ0ZXJQbHkobm9kZUxpc3Q6IFRyZWUuTm9kZVtdLCBtYWlubGluZTogVHJlZS5Ob2RlW10sIHBseTogbnVtYmVyKTogVHJlZS5Ob2RlW107XG4gIG1lcmdlKHRyZWU6IFRyZWUuTm9kZSk6IHZvaWQ7XG4gIHJlbW92ZUNldmFsKCk6IHZvaWQ7XG4gIHJlbW92ZUNvbXB1dGVyVmFyaWF0aW9ucygpOiB2b2lkO1xuICBwYXJlbnROb2RlKHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZTtcbiAgZ2V0UGFyZW50Q2xvY2sobm9kZTogVHJlZS5Ob2RlLCBwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLkNsb2NrIHwgdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGQocm9vdDogVHJlZS5Ob2RlKTogVHJlZVdyYXBwZXIge1xuXG4gIGZ1bmN0aW9uIGxhc3ROb2RlKCk6IFRyZWUuTm9kZSB7XG4gICAgcmV0dXJuIG9wcy5maW5kSW5NYWlubGluZShyb290LCBmdW5jdGlvbihub2RlOiBUcmVlLk5vZGUpIHtcbiAgICAgIHJldHVybiAhbm9kZS5jaGlsZHJlbi5sZW5ndGg7XG4gICAgfSkhO1xuICB9XG5cbiAgZnVuY3Rpb24gbm9kZUF0UGF0aChwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLk5vZGUge1xuICAgIHJldHVybiBub2RlQXRQYXRoRnJvbShyb290LCBwYXRoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG5vZGVBdFBhdGhGcm9tKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlIHtcbiAgICBpZiAocGF0aCA9PT0gJycpIHJldHVybiBub2RlO1xuICAgIGNvbnN0IGNoaWxkID0gb3BzLmNoaWxkQnlJZChub2RlLCB0cmVlUGF0aC5oZWFkKHBhdGgpKTtcbiAgICByZXR1cm4gY2hpbGQgPyBub2RlQXRQYXRoRnJvbShjaGlsZCwgdHJlZVBhdGgudGFpbChwYXRoKSkgOiBub2RlO1xuICB9XG5cbiAgZnVuY3Rpb24gbm9kZUF0UGF0aE9yTnVsbChwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLk5vZGUgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiBub2RlQXRQYXRoT3JOdWxsRnJvbShyb290LCBwYXRoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG5vZGVBdFBhdGhPck51bGxGcm9tKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAocGF0aCA9PT0gJycpIHJldHVybiBub2RlO1xuICAgIGNvbnN0IGNoaWxkID0gb3BzLmNoaWxkQnlJZChub2RlLCB0cmVlUGF0aC5oZWFkKHBhdGgpKTtcbiAgICByZXR1cm4gY2hpbGQgPyBub2RlQXRQYXRoT3JOdWxsRnJvbShjaGlsZCwgdHJlZVBhdGgudGFpbChwYXRoKSkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBmdW5jdGlvbiBsb25nZXN0VmFsaWRQYXRoRnJvbShub2RlOiBUcmVlLk5vZGUsIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuUGF0aCB7XG4gICAgdmFyIGlkID0gdHJlZVBhdGguaGVhZChwYXRoKTtcbiAgICBjb25zdCBjaGlsZCA9IG9wcy5jaGlsZEJ5SWQobm9kZSwgaWQpO1xuICAgIHJldHVybiBjaGlsZCA/IGlkICsgbG9uZ2VzdFZhbGlkUGF0aEZyb20oY2hpbGQsIHRyZWVQYXRoLnRhaWwocGF0aCkpIDogJyc7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRDdXJyZW50Tm9kZXNBZnRlclBseShub2RlTGlzdDogVHJlZS5Ob2RlW10sIG1haW5saW5lOiBUcmVlLk5vZGVbXSwgcGx5OiBudW1iZXIpOiBUcmVlLk5vZGVbXSB7XG4gICAgdmFyIG5vZGUsIG5vZGVzID0gW107XG4gICAgZm9yICh2YXIgaSBpbiBub2RlTGlzdCkge1xuICAgICAgbm9kZSA9IG5vZGVMaXN0W2ldO1xuICAgICAgaWYgKG5vZGUucGx5IDw9IHBseSAmJiBtYWlubGluZVtpXS5pZCAhPT0gbm9kZS5pZCkgYnJlYWs7XG4gICAgICBpZiAobm9kZS5wbHkgPiBwbHkpIG5vZGVzLnB1c2gobm9kZSk7XG4gICAgfVxuICAgIHJldHVybiBub2RlcztcbiAgfTtcblxuICBmdW5jdGlvbiBwYXRoSXNNYWlubGluZShwYXRoOiBUcmVlLlBhdGgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gcGF0aElzTWFpbmxpbmVGcm9tKHJvb3QsIHBhdGgpO1xuICB9XG5cbiAgZnVuY3Rpb24gcGF0aEV4aXN0cyhwYXRoOiBUcmVlLlBhdGgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISFub2RlQXRQYXRoT3JOdWxsKHBhdGgpO1xuICB9XG5cbiAgZnVuY3Rpb24gcGF0aElzTWFpbmxpbmVGcm9tKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogYm9vbGVhbiB7XG4gICAgaWYgKHBhdGggPT09ICcnKSByZXR1cm4gdHJ1ZTtcbiAgICBjb25zdCBwYXRoSWQgPSB0cmVlUGF0aC5oZWFkKHBhdGgpLFxuICAgIGNoaWxkID0gbm9kZS5jaGlsZHJlblswXTtcbiAgICBpZiAoIWNoaWxkIHx8IGNoaWxkLmlkICE9PSBwYXRoSWQpIHJldHVybiBmYWxzZTtcbiAgICByZXR1cm4gcGF0aElzTWFpbmxpbmVGcm9tKGNoaWxkLCB0cmVlUGF0aC50YWlsKHBhdGgpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhdGhJc0ZvcmNlZFZhcmlhdGlvbihwYXRoOiBUcmVlLlBhdGgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISFnZXROb2RlTGlzdChwYXRoKS5maW5kKG4gPT4gbi5mb3JjZVZhcmlhdGlvbik7XG4gIH1cblxuICBmdW5jdGlvbiBsYXN0TWFpbmxpbmVOb2RlRnJvbShub2RlOiBUcmVlLk5vZGUsIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZSB7XG4gICAgaWYgKHBhdGggPT09ICcnKSByZXR1cm4gbm9kZTtcbiAgICBjb25zdCBwYXRoSWQgPSB0cmVlUGF0aC5oZWFkKHBhdGgpO1xuICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlblswXTtcbiAgICBpZiAoIWNoaWxkIHx8IGNoaWxkLmlkICE9PSBwYXRoSWQpIHJldHVybiBub2RlO1xuICAgIHJldHVybiBsYXN0TWFpbmxpbmVOb2RlRnJvbShjaGlsZCwgdHJlZVBhdGgudGFpbChwYXRoKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXROb2RlTGlzdChwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLk5vZGVbXSB7XG4gICAgcmV0dXJuIG9wcy5jb2xsZWN0KHJvb3QsIGZ1bmN0aW9uKG5vZGU6IFRyZWUuTm9kZSkge1xuICAgICAgY29uc3QgaWQgPSB0cmVlUGF0aC5oZWFkKHBhdGgpO1xuICAgICAgaWYgKGlkID09PSAnJykgcmV0dXJuO1xuICAgICAgcGF0aCA9IHRyZWVQYXRoLnRhaWwocGF0aCk7XG4gICAgICByZXR1cm4gb3BzLmNoaWxkQnlJZChub2RlLCBpZCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRPcGVuaW5nKG5vZGVMaXN0OiBUcmVlLk5vZGVbXSk6IFRyZWUuT3BlbmluZyB8IHVuZGVmaW5lZCB7XG4gICAgdmFyIG9wZW5pbmc6IFRyZWUuT3BlbmluZyB8IHVuZGVmaW5lZDtcbiAgICBub2RlTGlzdC5mb3JFYWNoKGZ1bmN0aW9uKG5vZGU6IFRyZWUuTm9kZSkge1xuICAgICAgb3BlbmluZyA9IG5vZGUub3BlbmluZyB8fCBvcGVuaW5nO1xuICAgIH0pO1xuICAgIHJldHVybiBvcGVuaW5nO1xuICB9XG5cbiAgZnVuY3Rpb24gdXBkYXRlQXQocGF0aDogVHJlZS5QYXRoLCB1cGRhdGU6IChub2RlOiBUcmVlLk5vZGUpID0+IHZvaWQpOiBUcmVlLk5vZGUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IG5vZGUgPSBub2RlQXRQYXRoT3JOdWxsKHBhdGgpO1xuICAgIGlmIChub2RlKSB7XG4gICAgICB1cGRhdGUobm9kZSk7XG4gICAgICByZXR1cm4gbm9kZTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gcmV0dXJucyBuZXcgcGF0aFxuICBmdW5jdGlvbiBhZGROb2RlKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5QYXRoIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcGF0aCArIG5vZGUuaWQsXG4gICAgZXhpc3RpbmcgPSBub2RlQXRQYXRoT3JOdWxsKG5ld1BhdGgpO1xuICAgIGlmIChleGlzdGluZykge1xuICAgICAgKFsnZGVzdHMnLCAnZHJvcHMnLCAnY2xvY2snXSBhcyBBcnJheTxrZXlvZiBUcmVlLk5vZGU+KS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGlmIChkZWZpbmVkKG5vZGVba2V5XSkgJiYgIWRlZmluZWQoZXhpc3Rpbmdba2V5XSkpIGV4aXN0aW5nW2tleV0gPSBub2RlW2tleV0gYXMgbmV2ZXI7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBuZXdQYXRoO1xuICAgIH1cbiAgICByZXR1cm4gdXBkYXRlQXQocGF0aCwgZnVuY3Rpb24ocGFyZW50OiBUcmVlLk5vZGUpIHtcbiAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKG5vZGUpO1xuICAgIH0pID8gbmV3UGF0aCA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGFkZE5vZGVzKG5vZGVzOiBUcmVlLk5vZGVbXSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5QYXRoIHwgdW5kZWZpbmVkIHtcbiAgICB2YXIgbm9kZSA9IG5vZGVzWzBdO1xuICAgIGlmICghbm9kZSkgcmV0dXJuIHBhdGg7XG4gICAgY29uc3QgbmV3UGF0aCA9IGFkZE5vZGUobm9kZSwgcGF0aCk7XG4gICAgcmV0dXJuIG5ld1BhdGggPyBhZGROb2Rlcyhub2Rlcy5zbGljZSgxKSwgbmV3UGF0aCkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBmdW5jdGlvbiBkZWxldGVOb2RlQXQocGF0aDogVHJlZS5QYXRoKTogdm9pZCB7XG4gICAgb3BzLnJlbW92ZUNoaWxkKHBhcmVudE5vZGUocGF0aCksIHRyZWVQYXRoLmxhc3QocGF0aCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJvbW90ZUF0KHBhdGg6IFRyZWUuUGF0aCwgdG9NYWlubGluZTogYm9vbGVhbik6IHZvaWQge1xuICAgIHZhciBub2RlcyA9IGdldE5vZGVMaXN0KHBhdGgpO1xuICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGggLSAyOyBpID49IDA7IGktLSkge1xuICAgICAgdmFyIG5vZGUgPSBub2Rlc1tpICsgMV07XG4gICAgICB2YXIgcGFyZW50ID0gbm9kZXNbaV07XG4gICAgICBpZiAocGFyZW50LmNoaWxkcmVuWzBdLmlkICE9PSBub2RlLmlkKSB7XG4gICAgICAgIG9wcy5yZW1vdmVDaGlsZChwYXJlbnQsIG5vZGUuaWQpO1xuICAgICAgICBwYXJlbnQuY2hpbGRyZW4udW5zaGlmdChub2RlKTtcbiAgICAgICAgaWYgKCF0b01haW5saW5lKSBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAobm9kZS5mb3JjZVZhcmlhdGlvbikge1xuICAgICAgICBub2RlLmZvcmNlVmFyaWF0aW9uID0gZmFsc2U7XG4gICAgICAgIGlmICghdG9NYWlubGluZSkgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gc2V0Q29tbWVudEF0KGNvbW1lbnQ6IFRyZWUuQ29tbWVudCwgcGF0aDogVHJlZS5QYXRoKSB7XG4gICAgcmV0dXJuICFjb21tZW50LnRleHQgPyBkZWxldGVDb21tZW50QXQoY29tbWVudC5pZCwgcGF0aCkgOiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbihub2RlKSB7XG4gICAgICBub2RlLmNvbW1lbnRzID0gbm9kZS5jb21tZW50cyB8fCBbXTtcbiAgICAgIGNvbnN0IGV4aXN0aW5nID0gbm9kZS5jb21tZW50cy5maW5kKGZ1bmN0aW9uKGMpIHtcbiAgICAgICAgcmV0dXJuIGMuaWQgPT09IGNvbW1lbnQuaWQ7XG4gICAgICB9KTtcbiAgICAgIGlmIChleGlzdGluZykgZXhpc3RpbmcudGV4dCA9IGNvbW1lbnQudGV4dDtcbiAgICAgIGVsc2Ugbm9kZS5jb21tZW50cy5wdXNoKGNvbW1lbnQpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZGVsZXRlQ29tbWVudEF0KGlkOiBzdHJpbmcsIHBhdGg6IFRyZWUuUGF0aCkge1xuICAgIHJldHVybiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbihub2RlKSB7XG4gICAgICB2YXIgY29tbWVudHMgPSAobm9kZS5jb21tZW50cyB8fCBbXSkuZmlsdGVyKGZ1bmN0aW9uKGMpIHtcbiAgICAgICAgcmV0dXJuIGMuaWQgIT09IGlkXG4gICAgICB9KTtcbiAgICAgIG5vZGUuY29tbWVudHMgPSBjb21tZW50cy5sZW5ndGggPyBjb21tZW50cyA6IHVuZGVmaW5lZDtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNldEdseXBoc0F0KGdseXBoczogVHJlZS5HbHlwaFtdLCBwYXRoOiBUcmVlLlBhdGgpIHtcbiAgICByZXR1cm4gdXBkYXRlQXQocGF0aCwgZnVuY3Rpb24obm9kZSkge1xuICAgICAgbm9kZS5nbHlwaHMgPSBnbHlwaHM7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBwYXJlbnROb2RlKHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZSB7XG4gICAgcmV0dXJuIG5vZGVBdFBhdGgodHJlZVBhdGguaW5pdChwYXRoKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRQYXJlbnRDbG9jayhub2RlOiBUcmVlLk5vZGUsIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuQ2xvY2sgfCB1bmRlZmluZWQge1xuICAgIGlmICghKCdwYXJlbnRDbG9jaycgaW4gbm9kZSkpIHtcbiAgICAgIGNvbnN0IHBhciA9IHBhdGggJiYgcGFyZW50Tm9kZShwYXRoKTtcbiAgICAgIGlmICghcGFyKSBub2RlLnBhcmVudENsb2NrID0gbm9kZS5jbG9jaztcbiAgICAgIGVsc2UgaWYgKCEoJ2Nsb2NrJyBpbiBwYXIpKSBub2RlLnBhcmVudENsb2NrID0gdW5kZWZpbmVkO1xuICAgICAgZWxzZSBub2RlLnBhcmVudENsb2NrID0gcGFyLmNsb2NrO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZS5wYXJlbnRDbG9jaztcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcm9vdCxcbiAgICBsYXN0UGx5KCk6IG51bWJlciB7XG4gICAgICByZXR1cm4gbGFzdE5vZGUoKS5wbHk7XG4gICAgfSxcbiAgICBub2RlQXRQYXRoLFxuICAgIGdldE5vZGVMaXN0LFxuICAgIGxvbmdlc3RWYWxpZFBhdGg6IChwYXRoOiBzdHJpbmcpID0+IGxvbmdlc3RWYWxpZFBhdGhGcm9tKHJvb3QsIHBhdGgpLFxuICAgIGdldE9wZW5pbmcsXG4gICAgdXBkYXRlQXQsXG4gICAgYWRkTm9kZSxcbiAgICBhZGROb2RlcyxcbiAgICBhZGREZXN0cyhkZXN0czogc3RyaW5nLCBwYXRoOiBUcmVlLlBhdGgsIG9wZW5pbmc/OiBUcmVlLk9wZW5pbmcpIHtcbiAgICAgIHJldHVybiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbihub2RlOiBUcmVlLk5vZGUpIHtcbiAgICAgICAgbm9kZS5kZXN0cyA9IGRlc3RzO1xuICAgICAgICBpZiAob3BlbmluZykgbm9kZS5vcGVuaW5nID0gb3BlbmluZztcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgc2V0U2hhcGVzKHNoYXBlczogVHJlZS5TaGFwZVtdLCBwYXRoOiBUcmVlLlBhdGgpIHtcbiAgICAgIHJldHVybiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbihub2RlOiBUcmVlLk5vZGUpIHtcbiAgICAgICAgbm9kZS5zaGFwZXMgPSBzaGFwZXM7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIHNldENvbW1lbnRBdCxcbiAgICBkZWxldGVDb21tZW50QXQsXG4gICAgc2V0R2x5cGhzQXQsXG4gICAgc2V0Q2xvY2tBdChjbG9jazogVHJlZS5DbG9jayB8IHVuZGVmaW5lZCwgcGF0aDogVHJlZS5QYXRoKSB7XG4gICAgICByZXR1cm4gdXBkYXRlQXQocGF0aCwgZnVuY3Rpb24obm9kZSkge1xuICAgICAgICBub2RlLmNsb2NrID0gY2xvY2s7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIHBhdGhJc01haW5saW5lLFxuICAgIHBhdGhJc0ZvcmNlZFZhcmlhdGlvbixcbiAgICBsYXN0TWFpbmxpbmVOb2RlKHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZSB7XG4gICAgICByZXR1cm4gbGFzdE1haW5saW5lTm9kZUZyb20ocm9vdCwgcGF0aCk7XG4gICAgfSxcbiAgICBwYXRoRXhpc3RzLFxuICAgIGRlbGV0ZU5vZGVBdCxcbiAgICBwcm9tb3RlQXQsXG4gICAgZm9yY2VWYXJpYXRpb25BdChwYXRoOiBUcmVlLlBhdGgsIGZvcmNlOiBib29sZWFuKSB7XG4gICAgICByZXR1cm4gdXBkYXRlQXQocGF0aCwgZnVuY3Rpb24obm9kZSkge1xuICAgICAgICBub2RlLmZvcmNlVmFyaWF0aW9uID0gZm9yY2U7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIGdldEN1cnJlbnROb2Rlc0FmdGVyUGx5LFxuICAgIG1lcmdlKHRyZWU6IFRyZWUuTm9kZSkge1xuICAgICAgb3BzLm1lcmdlKHJvb3QsIHRyZWUpO1xuICAgIH0sXG4gICAgcmVtb3ZlQ2V2YWwoKSB7XG4gICAgICBvcHMudXBkYXRlQWxsKHJvb3QsIGZ1bmN0aW9uKG4pIHtcbiAgICAgICAgZGVsZXRlIG4uY2V2YWw7XG4gICAgICAgIGRlbGV0ZSBuLnRocmVhdDtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgcmVtb3ZlQ29tcHV0ZXJWYXJpYXRpb25zKCkge1xuICAgICAgb3BzLm1haW5saW5lTm9kZUxpc3Qocm9vdCkuZm9yRWFjaChmdW5jdGlvbihuKSB7XG4gICAgICAgIG4uY2hpbGRyZW4gPSBuLmNoaWxkcmVuLmZpbHRlcihmdW5jdGlvbihjKSB7XG4gICAgICAgICAgcmV0dXJuICFjLmNvbXA7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBwYXJlbnROb2RlLFxuICAgIGdldFBhcmVudENsb2NrXG4gIH07XG59XG4iXX0=