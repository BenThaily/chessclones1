"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const snabbdom_1 = require("snabbdom");
const xhr_1 = require("./xhr");
const util_1 = require("./util");
function moderationCtrl(opts) {
    let data;
    let loading = false;
    const open = (username) => {
        if (opts.permissions.timeout) {
            loading = true;
            xhr_1.userModInfo(username).then(d => {
                data = d;
                loading = false;
                opts.redraw();
            });
        }
        else {
            data = {
                id: username,
                username
            };
        }
        opts.redraw();
    };
    const close = () => {
        data = undefined;
        loading = false;
        opts.redraw();
    };
    return {
        loading: () => loading,
        data: () => data,
        reasons: opts.reasons,
        permissions: () => opts.permissions,
        open,
        close,
        timeout(reason) {
            data && window.lichess.pubsub.emit('socket.send', 'timeout', {
                userId: data.id,
                reason: reason.key
            });
            close();
            opts.redraw();
        },
        shadowban() {
            loading = true;
            data && $.post('/mod/' + data.id + '/troll/true').then(() => data && open(data.username));
            opts.redraw();
        }
    };
}
exports.moderationCtrl = moderationCtrl;
function lineAction(username) {
    return snabbdom_1.h('i.mod', {
        attrs: {
            'data-icon': '',
            'data-username': username,
            title: 'Moderation'
        }
    });
}
exports.lineAction = lineAction;
function moderationView(ctrl) {
    if (!ctrl)
        return;
    if (ctrl.loading())
        return [snabbdom_1.h('div.loading', util_1.spinner())];
    const data = ctrl.data();
    if (!data)
        return;
    const perms = ctrl.permissions();
    const infos = data.history ? snabbdom_1.h('div.infos.block', [
        window.lichess.numberFormat(data.games || 0) + ' games',
        data.troll ? 'TROLL' : undefined,
        data.engine ? 'ENGINE' : undefined,
        data.booster ? 'BOOSTER' : undefined
    ].map(t => t && snabbdom_1.h('span', t)).concat([
        snabbdom_1.h('a', {
            attrs: {
                href: '/@/' + data.username + '?mod'
            }
        }, 'profile')
    ]).concat(perms.shadowban ? [
        snabbdom_1.h('a', {
            attrs: {
                href: '/mod/' + data.username + '/communication'
            }
        }, 'coms')
    ] : [])) : undefined;
    const timeout = perms.timeout ? snabbdom_1.h('div.timeout.block', [
        snabbdom_1.h('strong', 'Timeout 10 minutes for'),
        ...ctrl.reasons.map(r => {
            return snabbdom_1.h('a.text', {
                attrs: { 'data-icon': 'p' },
                hook: util_1.bind('click', () => ctrl.timeout(r))
            }, r.name);
        }),
        ...((data.troll || !perms.shadowban) ? [] : [snabbdom_1.h('div.shadowban', [
                'Or ',
                snabbdom_1.h('button.button.button-red.button-empty', {
                    hook: util_1.bind('click', ctrl.shadowban)
                }, 'shadowban')
            ])])
    ]) : snabbdom_1.h('div.timeout.block', [
        snabbdom_1.h('strong', 'Moderation'),
        snabbdom_1.h('a.text', {
            attrs: { 'data-icon': 'p' },
            hook: util_1.bind('click', () => ctrl.timeout(ctrl.reasons[0]))
        }, 'Timeout 10 minutes')
    ]);
    const history = data.history ? snabbdom_1.h('div.history.block', [
        snabbdom_1.h('strong', 'Timeout history'),
        snabbdom_1.h('table', snabbdom_1.h('tbody.slist', {
            hook: {
                insert: () => window.lichess.pubsub.emit('content_loaded')
            }
        }, data.history.map(function (e) {
            return snabbdom_1.h('tr', [
                snabbdom_1.h('td.reason', e.reason),
                snabbdom_1.h('td.mod', e.mod),
                snabbdom_1.h('td', snabbdom_1.h('time.timeago', {
                    attrs: { datetime: e.date }
                }))
            ]);
        })))
    ]) : undefined;
    return [
        snabbdom_1.h('div.top', { key: 'mod-' + data.id }, [
            snabbdom_1.h('span.text', {
                attrs: { 'data-icon': '' },
            }, [util_1.userLink(data.username)]),
            snabbdom_1.h('a', {
                attrs: { 'data-icon': 'L' },
                hook: util_1.bind('click', ctrl.close)
            })
        ]),
        snabbdom_1.h('div.mchat__content.moderation', [
            infos,
            timeout,
            history
        ])
    ];
}
exports.moderationView = moderationView;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZXJhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlcmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQTRCO0FBRzVCLCtCQUFtQztBQUNuQyxpQ0FBaUQ7QUFFakQsU0FBZ0IsY0FBYyxDQUFDLElBQW9CO0lBRWpELElBQUksSUFBZ0MsQ0FBQztJQUNyQyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFFcEIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxRQUFnQixFQUFFLEVBQUU7UUFDaEMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRTtZQUM1QixPQUFPLEdBQUcsSUFBSSxDQUFDO1lBQ2YsaUJBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzdCLElBQUksR0FBRyxDQUFDLENBQUM7Z0JBQ1QsT0FBTyxHQUFHLEtBQUssQ0FBQztnQkFDaEIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLElBQUksR0FBRztnQkFDTCxFQUFFLEVBQUUsUUFBUTtnQkFDWixRQUFRO2FBQ1QsQ0FBQztTQUNIO1FBQ0QsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztJQUVGLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRTtRQUNqQixJQUFJLEdBQUcsU0FBUyxDQUFDO1FBQ2pCLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztJQUVGLE9BQU87UUFDTCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTztRQUN0QixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSTtRQUNoQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87UUFDckIsV0FBVyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FB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QUFHLEVBQUM7Z0JBQ3pCLElBQUksRUFBRSxXQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDaEMsQ0FBQztTQUNILENBQUM7UUFDRixZQUFDLENBQUMsK0JBQStCLEVBQUU7WUFDakMsS0FBSztZQUNMLE9BQU87WUFDUCxPQUFPO1NBQ1IsQ0FBQztLQUNILENBQUM7QUFDTixDQUFDO0FBbkZELHdDQW1GQztBQUFBLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBoIH0gZnJvbSAnc25hYmJkb20nXG5pbXBvcnQgeyBWTm9kZSB9IGZyb20gJ3NuYWJiZG9tL3Zub2RlJ1xuaW1wb3J0IHsgTW9kZXJhdGlvbkN0cmwsIE1vZGVyYXRpb25PcHRzLCBNb2RlcmF0aW9uRGF0YSwgTW9kZXJhdGlvblJlYXNvbiB9IGZyb20gJy4vaW50ZXJmYWNlcydcbmltcG9ydCB7IHVzZXJNb2RJbmZvIH0gZnJvbSAnLi94aHInXG5pbXBvcnQgeyB1c2VyTGluaywgc3Bpbm5lciwgYmluZCB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBtb2RlcmF0aW9uQ3RybChvcHRzOiBNb2RlcmF0aW9uT3B0cyk6IE1vZGVyYXRpb25DdHJsIHtcblxuICBsZXQgZGF0YTogTW9kZXJhdGlvbkRhdGEgfCB1bmRlZmluZWQ7XG4gIGxldCBsb2FkaW5nID0gZmFsc2U7XG5cbiAgY29uc3Qgb3BlbiA9ICh1c2VybmFtZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKG9wdHMucGVybWlzc2lvbnMudGltZW91dCkge1xuICAgICAgbG9hZGluZyA9IHRydWU7XG4gICAgICB1c2VyTW9kSW5mbyh1c2VybmFtZSkudGhlbihkID0+IHtcbiAgICAgICAgZGF0YSA9IGQ7XG4gICAgICAgIGxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgb3B0cy5yZWRyYXcoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhID0ge1xuICAgICAgICBpZDogdXNlcm5hbWUsXG4gICAgICAgIHVzZXJuYW1lXG4gICAgICB9O1xuICAgIH1cbiAgICBvcHRzLnJlZHJhdygpO1xuICB9O1xuXG4gIGNvbnN0IGNsb3NlID0gKCkgPT4ge1xuICAgIGRhdGEgPSB1bmRlZmluZWQ7XG4gICAgbG9hZGluZyA9IGZhbHNlO1xuICAgIG9wdHMucmVkcmF3KCk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBsb2FkaW5nOiAoKSA9PiBsb2FkaW5nLFxuICAgIGRhdGE6ICgpID0+IGRhdGEsXG4gICAgcmVhc29uczogb3B0cy5yZWFzb25zLFxuICAgIHBlcm1pc3Npb25zOiAoKSA9PiBvcHRzLnBlcm1pc3Npb25zLFxuICAgIG9wZW4sXG4gICAgY2xvc2UsXG4gICAgdGltZW91dChyZWFzb246IE1vZGVyYXRpb25SZWFzb24pIHtcbiAgICAgIGRhdGEgJiYgd2luZG93LmxpY2hlc3MucHVic3ViLmVtaXQoJ3NvY2tldC5zZW5kJywgJ3RpbWVvdXQnLCB7XG4gICAgICAgIHVzZXJJZDogZGF0YS5pZCxcbiAgICAgICAgcmVhc29uOiByZWFzb24ua2V5XG4gICAgICB9KTtcbiAgICAgIGNsb3NlKCk7XG4gICAgICBvcHRzLnJlZHJhdygpO1xuICAgIH0sXG4gICAgc2hhZG93YmFuKCkge1xuICAgICAgbG9hZGluZyA9IHRydWU7XG4gICAgICBkYXRhICYmICQucG9zdCgnL21vZC8nICsgZGF0YS5pZCArICcvdHJvbGwvdHJ1ZScpLnRoZW4oKCkgPT4gZGF0YSAmJiBvcGVuKGRhdGEudXNlcm5hbWUpKTtcbiAgICAgIG9wdHMucmVkcmF3KCk7XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbGluZUFjdGlvbih1c2VybmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBoKCdpLm1vZCcsIHtcbiAgICBhdHRyczoge1xuICAgICAgJ2RhdGEtaWNvbic6ICfugIInLFxuICAgICAgJ2RhdGEtdXNlcm5hbWUnOiB1c2VybmFtZSxcbiAgICAgIHRpdGxlOiAnTW9kZXJhdGlvbidcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbW9kZXJhdGlvblZpZXcoY3RybD86IE1vZGVyYXRpb25DdHJsKTogVk5vZGVbXSB8IHVuZGVmaW5lZCB7XG4gIGlmICghY3RybCkgcmV0dXJuO1xuICBpZiAoY3RybC5sb2FkaW5nKCkpIHJldHVybiBbaCgnZGl2LmxvYWRpbmcnLCBzcGlubmVyKCkpXTtcbiAgY29uc3QgZGF0YSA9IGN0cmwuZGF0YSgpO1xuICBpZiAoIWRhdGEpIHJldHVybjtcbiAgY29uc3QgcGVybXMgPSBjdHJsLnBlcm1pc3Npb25zKCk7XG5cbiAgY29uc3QgaW5mb3MgPSBkYXRhLmhpc3RvcnkgPyBoKCdkaXYuaW5mb3MuYmxvY2snLCBbXG4gICAgd2luZG93LmxpY2hlc3MubnVtYmVyRm9ybWF0KGRhdGEuZ2FtZXMgfHwgMCkgKyAnIGdhbWVzJyxcbiAgICBkYXRhLnRyb2xsID8gJ1RST0xMJyA6IHVuZGVmaW5lZCxcbiAgICBkYXRhLmVuZ2luZSA/ICdFTkdJTkUnIDogdW5kZWZpbmVkLFxuICAgIGRhdGEuYm9vc3RlciA/ICdCT09TVEVSJyA6IHVuZGVmaW5lZFxuICBdLm1hcCh0ID0+IHQgJiYgaCgnc3BhbicsIHQpKS5jb25jYXQoW1xuICAgIGgoJ2EnLCB7XG4gICAgICBhdHRyczoge1xuICAgICAgICBocmVmOiAnL0AvJyArIGRhdGEudXNlcm5hbWUgKyAnP21vZCdcbiAgICAgIH1cbiAgICB9LCAncHJvZmlsZScpXG4gIF0pLmNvbmNhdChcbiAgICBwZXJtcy5zaGFkb3diYW4gPyBbXG4gICAgICBoKCdhJywge1xuICAgICAgICBhdHRyczoge1xuICAgICAgICAgIGhyZWY6ICcvbW9kLycgKyBkYXRhLnVzZXJuYW1lICsgJy9jb21tdW5pY2F0aW9uJ1xuICAgICAgICB9XG4gICAgICB9LCAnY29tcycpXG4gICAgXSA6IFtdKSkgOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCB0aW1lb3V0ID0gcGVybXMudGltZW91dCA/IGgoJ2Rpdi50aW1lb3V0LmJsb2NrJywgW1xuICAgICAgaCgnc3Ryb25nJywgJ1RpbWVvdXQgMTAgbWludXRlcyBmb3InKSxcbiAgICAgIC4uLmN0cmwucmVhc29ucy5tYXAociA9PiB7XG4gICAgICAgIHJldHVybiBoKCdhLnRleHQnLCB7XG4gICAgICAgICAgYXR0cnM6IHsgJ2RhdGEtaWNvbic6ICdwJyB9LFxuICAgICAgICAgIGhvb2s6IGJpbmQoJ2NsaWNrJywgKCkgPT4gY3RybC50aW1lb3V0KHIpKVxuICAgICAgICB9LCByLm5hbWUpO1xuICAgICAgfSksXG4gICAgICAuLi4oXG4gICAgICAgIChkYXRhLnRyb2xsIHx8ICFwZXJtcy5zaGFkb3diYW4pID8gW10gOiBbaCgnZGl2LnNoYWRvd2JhbicsIFtcbiAgICAgICAgICAnT3IgJyxcbiAgICAgICAgICBoKCdidXR0b24uYnV0dG9uLmJ1dHRvbi1yZWQuYnV0dG9uLWVtcHR5Jywge1xuICAgICAgICAgICAgaG9vazogYmluZCgnY2xpY2snLCBjdHJsLnNoYWRvd2JhbilcbiAgICAgICAgICB9LCAnc2hhZG93YmFuJylcbiAgICAgICAgXSldKVxuICAgIF0pIDogaCgnZGl2LnRpbWVvdXQuYmxvY2snLCBbXG4gICAgICBoKCdzdHJvbmcnLCAnTW9kZXJhdGlvbicpLFxuICAgICAgaCgnYS50ZXh0Jywge1xuICAgICAgICBhdHRyczogeyAnZGF0YS1pY29uJzogJ3AnIH0sXG4gICAgICAgIGhvb2s6IGJpbmQoJ2NsaWNrJywgKCkgPT4gY3RybC50aW1lb3V0KGN0cmwucmVhc29uc1swXSkpXG4gICAgICB9LCAnVGltZW91dCAxMCBtaW51dGVzJylcbiAgICBdKTtcblxuICAgIGNvbnN0IGhpc3RvcnkgPSBkYXRhLmhpc3RvcnkgPyBoKCdkaXYuaGlzdG9yeS5ibG9jaycsIFtcbiAgICAgIGgoJ3N0cm9uZycsICdUaW1lb3V0IGhpc3RvcnknKSxcbiAgICAgIGgoJ3RhYmxlJywgaCgndGJvZHkuc2xpc3QnLCB7XG4gICAgICAgIGhvb2s6IHtcbiAgICAgICAgICBpbnNlcnQ6ICgpID0+IHdpbmRvdy5saWNoZXNzLnB1YnN1Yi5lbWl0KCdjb250ZW50X2xvYWRlZCcpXG4gICAgICAgIH1cbiAgICAgIH0sIGRhdGEuaGlzdG9yeS5tYXAoZnVuY3Rpb24oZSkge1xuICAgICAgICByZXR1cm4gaCgndHInLCBbXG4gICAgICAgICAgaCgndGQucmVhc29uJywgZS5yZWFzb24pLFxuICAgICAgICAgIGgoJ3RkLm1vZCcsIGUubW9kKSxcbiAgICAgICAgICBoKCd0ZCcsIGgoJ3RpbWUudGltZWFnbycsIHtcbiAgICAgICAgICAgIGF0dHJzOiB7IGRhdGV0aW1lOiBlLmRhdGUgfVxuICAgICAgICAgIH0pKVxuICAgICAgICBdKTtcbiAgICAgIH0pKSlcbiAgICBdKSA6IHVuZGVmaW5lZDtcblxuICAgIHJldHVybiBbXG4gICAgICBoKCdkaXYudG9wJywgeyBrZXk6ICdtb2QtJyArIGRhdGEuaWQgfSwgW1xuICAgICAgICBoKCdzcGFuLnRleHQnLCB7XG4gICAgICAgICAgYXR0cnM6IHsnZGF0YS1pY29uJzogJ+6AgicgfSxcbiAgICAgICAgfSwgW3VzZXJMaW5rKGRhdGEudXNlcm5hbWUpXSksXG4gICAgICAgIGgoJ2EnLCB7XG4gICAgICAgICAgYXR0cnM6IHsnZGF0YS1pY29uJzogJ0wnfSxcbiAgICAgICAgICBob29rOiBiaW5kKCdjbGljaycsIGN0cmwuY2xvc2UpXG4gICAgICAgIH0pXG4gICAgICBdKSxcbiAgICAgIGgoJ2Rpdi5tY2hhdF9fY29udGVudC5tb2RlcmF0aW9uJywgW1xuICAgICAgICBpbmZvcyxcbiAgICAgICAgdGltZW91dCxcbiAgICAgICAgaGlzdG9yeVxuICAgICAgXSlcbiAgICBdO1xufTtcbiJdfQ==