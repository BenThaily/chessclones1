"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const chess_1 = require("chess");
const EVAL_REGEX = new RegExp(''
    + /^info depth (\d+) seldepth \d+ multipv (\d+) /.source
    + /score (cp|mate) ([-\d]+) /.source
    + /(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source
    + /(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source
    + /pv (.+)/.source);
class Protocol {
    constructor(send, opts) {
        this.send = send;
        this.opts = opts;
        this.work = null;
        this.curEval = null;
        this.expectedPvs = 1;
        this.stopped = defer();
        this.stopped.resolve();
        // get engine name/version
        this.send('uci');
        // analyse without contempt
        this.setOption('UCI_AnalyseMode', 'true');
        this.setOption('Analysis Contempt', 'Off');
        if (opts.variant === 'fromPosition' || opts.variant === 'chess960')
            this.setOption('UCI_Chess960', 'true');
        else if (opts.variant === 'antichess')
            this.setOption('UCI_Variant', 'giveaway');
        else if (opts.variant !== 'standard')
            this.setOption('UCI_Variant', chess_1.variantToRules(opts.variant));
    }
    setOption(name, value) {
        this.send(`setoption name ${name} value ${value}`);
    }
    received(text) {
        if (text.startsWith('id name '))
            this.engineName = text.substring('id name '.length);
        else if (text.startsWith('bestmove ')) {
            if (!this.stopped)
                this.stopped = defer();
            this.stopped.resolve();
            if (this.work && this.curEval)
                this.work.emit(this.curEval);
            return;
        }
        if (!this.work)
            return;
        let matches = text.match(EVAL_REGEX);
        if (!matches)
            return;
        let depth = parseInt(matches[1]), multiPv = parseInt(matches[2]), isMate = matches[3] === 'mate', ev = parseInt(matches[4]), evalType = matches[5], nodes = parseInt(matches[6]), elapsedMs = parseInt(matches[7]), moves = matches[8].split(' ');
        // Sometimes we get #0. Let's just skip it.
        if (isMate && !ev)
            return;
        // Track max pv index to determine when pv prints are done.
        if (this.expectedPvs < multiPv)
            this.expectedPvs = multiPv;
        if (depth < this.opts.minDepth)
            return;
        let pivot = this.work.threatMode ? 0 : 1;
        if (this.work.ply % 2 === pivot)
            ev = -ev;
        // For now, ignore most upperbound/lowerbound messages.
        // The exception is for multiPV, sometimes non-primary PVs
        // only have an upperbound.
        // See: https://github.com/ddugovic/Stockfish/issues/228
        if (evalType && multiPv === 1)
            return;
        let pvData = {
            moves,
            cp: isMate ? undefined : ev,
            mate: isMate ? ev : undefined,
            depth,
        };
        if (multiPv === 1) {
            this.curEval = {
                fen: this.work.currentFen,
                maxDepth: this.work.maxDepth,
                depth,
                knps: nodes / elapsedMs,
                nodes,
                cp: isMate ? undefined : ev,
                mate: isMate ? ev : undefined,
                pvs: [pvData],
                millis: elapsedMs
            };
        }
        else if (this.curEval) {
            this.curEval.pvs.push(pvData);
            this.curEval.depth = Math.min(this.curEval.depth, depth);
        }
        if (multiPv === this.expectedPvs && this.curEval) {
            this.work.emit(this.curEval);
        }
    }
    start(w) {
        if (!this.stopped) {
            // TODO: Work is started by basically doing stop().then(() => start(w)).
            // There is a race condition where multiple callers are waiting for
            // completion of the same stop future, and so they will start work at
            // the same time.
            // This can lead to all kinds of issues, including deadlocks. Instead
            // we ignore all but the first request. The engine will show as loading
            // indefinitely. Until this is fixed, it is still better than a
            // possible deadlock.
            console.log('ceval: tried to start analysing before requesting stop');
            return;
        }
        this.work = w;
        this.curEval = null;
        this.stopped = null;
        this.expectedPvs = 1;
        if (this.opts.threads)
            this.setOption('Threads', this.opts.threads());
        if (this.opts.hashSize)
            this.setOption('Hash', this.opts.hashSize());
        this.setOption('MultiPV', this.work.multiPv);
        this.send(['position', 'fen', this.work.initialFen, 'moves'].concat(this.work.moves).join(' '));
        if (this.work.maxDepth >= 99)
            this.send('go depth 99');
        else
            this.send('go movetime 90000 depth ' + this.work.maxDepth);
    }
    stop() {
        if (!this.stopped) {
            this.work = null;
            this.stopped = defer();
            this.send('stop');
        }
        return this.stopped.promise;
    }
    isComputing() {
        return !this.stopped;
    }
}
exports.default = Protocol;
;
function defer() {
    const deferred = {};
    deferred.promise = new Promise(function (resolve, reject) {
        deferred.resolve = resolve;
        deferred.reject = reject;
    });
    return deferred;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvY2tmaXNoUHJvdG9jb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvY2tmaXNoUHJvdG9jb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBdUM7QUFHdkMsTUFBTSxVQUFVLEdBQUcsSUFBSSxNQUFNLENBQUMsRUFBRTtNQUM1QiwrQ0FBK0MsQ0FBQyxNQUFNO01BQ3RELDJCQUEyQixDQUFDLE1BQU07TUFDbEMsOENBQThDLENBQUMsTUFBTTtNQUNyRCwrQ0FBK0MsQ0FBQyxNQUFNO01BQ3RELFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV0QixNQUFxQixRQUFRO0lBUTNCLFlBQW9CLElBQTJCLEVBQVUsSUFBZ0I7UUFBckQsU0FBSSxHQUFKLElBQUksQ0FBdUI7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBUGpFLFNBQUksR0FBZ0IsSUFBSSxDQUFDO1FBQ3pCLFlBQU8sR0FBMkIsSUFBSSxDQUFDO1FBQ3ZDLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1FBT3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxFQUFRLENBQUM7UUFDN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUV2QiwwQkFBMEI7UUFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVqQiwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTNDLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxjQUFjLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxVQUFVO1lBQ2hFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ3BDLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxXQUFXO1lBQ25DLElB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QUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztZQUNqQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssRUFBUSxDQUFDO1lBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkI7UUFDRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO0lBQzlCLENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBeklELDJCQXlJQztBQUFBLENBQUM7QUFFRixTQUFTLEtBQUs7SUFDWixNQUFNLFFBQVEsR0FBc0MsRUFBRSxDQUFBO0lBQ3RELFFBQVEsQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUksVUFBVSxPQUFPLEVBQUUsTUFBTTtRQUN6RCxRQUFRLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtRQUMxQixRQUFRLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtJQUMxQixDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sUUFBb0MsQ0FBQztBQUM5QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdmFyaWFudFRvUnVsZXMgfSBmcm9tICdjaGVzcyc7XG5pbXBvcnQgeyBXb3JrZXJPcHRzLCBXb3JrIH0gZnJvbSAnLi90eXBlcyc7XG5cbmNvbnN0IEVWQUxfUkVHRVggPSBuZXcgUmVnRXhwKCcnXG4gICsgL15pbmZvIGRlcHRoIChcXGQrKSBzZWxkZXB0aCBcXGQrIG11bHRpcHYgKFxcZCspIC8uc291cmNlXG4gICsgL3Njb3JlIChjcHxtYXRlKSAoWy1cXGRdKykgLy5zb3VyY2VcbiAgKyAvKD86KHVwcGVyfGxvd2VyKWJvdW5kICk/bm9kZXMgKFxcZCspIG5wcyBcXFMrIC8uc291cmNlXG4gICsgLyg/Omhhc2hmdWxsIFxcZCsgKT8oPzp0YmhpdHMgXFxkKyApP3RpbWUgKFxcUyspIC8uc291cmNlXG4gICsgL3B2ICguKykvLnNvdXJjZSk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFByb3RvY29sIHtcbiAgcHJpdmF0ZSB3b3JrOiBXb3JrIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgY3VyRXZhbDogVHJlZS5DbGllbnRFdmFsIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZXhwZWN0ZWRQdnMgPSAxO1xuICBwcml2YXRlIHN0b3BwZWQ6IERlZmVyUHJvbWlzZS5EZWZlcnJlZDx2b2lkPiB8IG51bGw7XG5cbiAgcHVibGljIGVuZ2luZU5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNlbmQ6IChjbWQ6IHN0cmluZykgPT4gdm9pZCwgcHJpdmF0ZSBvcHRzOiBXb3JrZXJPcHRzKSB7XG5cbiAgICB0aGlzLnN0b3BwZWQgPSBkZWZlcjx2b2lkPigpO1xuICAgIHRoaXMuc3RvcHBlZC5yZXNvbHZlKCk7XG5cbiAgICAvLyBnZXQgZW5naW5lIG5hbWUvdmVyc2lvblxuICAgIHRoaXMuc2VuZCgndWNpJyk7XG5cbiAgICAvLyBhbmFseXNlIHdpdGhvdXQgY29udGVtcHRcbiAgICB0aGlzLnNldE9wdGlvbignVUNJX0FuYWx5c2VNb2RlJywgJ3RydWUnKTtcbiAgICB0aGlzLnNldE9wdGlvbignQW5hbHlzaXMgQ29udGVtcHQnLCAnT2ZmJyk7XG5cbiAgICBpZiAob3B0cy52YXJpYW50ID09PSAnZnJvbVBvc2l0aW9uJyB8fCBvcHRzLnZhcmlhbnQgPT09ICdjaGVzczk2MCcpXG4gICAgICB0aGlzLnNldE9wdGlvbignVUNJX0NoZXNzOTYwJywgJ3RydWUnKTtcbiAgICBlbHNlIGlmIChvcHRzLnZhcmlhbnQgPT09ICdhbnRpY2hlc3MnKVxuICAgICAgdGhpcy5zZXRPcHRpb24oJ1VDSV9WYXJpYW50JywgJ2dpdmVhd2F5Jyk7XG4gICAgZWxzZSBpZiAob3B0cy52YXJpYW50ICE9PSAnc3RhbmRhcmQnKVxuICAgICAgdGhpcy5zZXRPcHRpb24oJ1VDSV9WYXJpYW50JywgdmFyaWFudFRvUnVsZXMob3B0cy52YXJpYW50KSk7XG4gIH1cblxuICBwcml2YXRlIHNldE9wdGlvbihuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICB0aGlzLnNlbmQoYHNldG9wdGlvbiBuYW1lICR7bmFtZX0gdmFsdWUgJHt2YWx1ZX1gKTtcbiAgfVxuXG4gIHJlY2VpdmVkKHRleHQ6IHN0cmluZykge1xuICAgIGlmICh0ZXh0LnN0YXJ0c1dpdGgoJ2lkIG5hbWUgJykpIHRoaXMuZW5naW5lTmFtZSA9IHRleHQuc3Vic3RyaW5nKCdpZCBuYW1lICcubGVuZ3RoKTtcbiAgICBlbHNlIGlmICh0ZXh0LnN0YXJ0c1dpdGgoJ2Jlc3Rtb3ZlICcpKSB7XG4gICAgICBpZiAoIXRoaXMuc3RvcHBlZCkgdGhpcy5zdG9wcGVkID0gZGVmZXI8dm9pZD4oKTtcbiAgICAgIHRoaXMuc3RvcHBlZC5yZXNvbHZlKCk7XG4gICAgICBpZiAodGhpcy53b3JrICYmIHRoaXMuY3VyRXZhbCkgdGhpcy53b3JrLmVtaXQodGhpcy5jdXJFdmFsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLndvcmspIHJldHVybjtcblxuICAgIGxldCBtYXRjaGVzID0gdGV4dC5tYXRjaChFVkFMX1JFR0VYKTtcbiAgICBpZiAoIW1hdGNoZXMpIHJldHVybjtcblxuICAgIGxldCBkZXB0aCA9IHBhcnNlSW50KG1hdGNoZXNbMV0pLFxuICAgICAgbXVsdGlQdiA9IHBhcnNlSW50KG1hdGNoZXNbMl0pLFxuICAgICAgaXNNYXRlID0gbWF0Y2hlc1szXSA9PT0gJ21hdGUnLFxuICAgICAgZXYgPSBwYXJzZUludChtYXRjaGVzWzRdKSxcbiAgICAgIGV2YWxUeXBlID0gbWF0Y2hlc1s1XSxcbiAgICAgIG5vZGVzID0gcGFyc2VJbnQobWF0Y2hlc1s2XSksXG4gICAgICBlbGFwc2VkTXM6IG51bWJlciA9IHBhcnNlSW50KG1hdGNoZXNbN10pLFxuICAgICAgbW92ZXMgPSBtYXRjaGVzWzhdLnNwbGl0KCcgJyk7XG5cbiAgICAvLyBTb21ldGltZXMgd2UgZ2V0ICMwLiBMZXQncyBqdXN0IHNraXAgaXQuXG4gICAgaWYgKGlzTWF0ZSAmJiAhZXYpIHJldHVybjtcblxuICAgIC8vIFRyYWNrIG1heCBwdiBpbmRleCB0byBkZXRlcm1pbmUgd2hlbiBwdiBwcmludHMgYXJlIGRvbmUuXG4gICAgaWYgKHRoaXMuZXhwZWN0ZWRQdnMgPCBtdWx0aVB2KSB0aGlzLmV4cGVjdGVkUHZzID0gbXVsdGlQdjtcblxuICAgIGlmIChkZXB0aCA8IHRoaXMub3B0cy5taW5EZXB0aCkgcmV0dXJuO1xuXG4gICAgbGV0IHBpdm90ID0gdGhpcy53b3JrLnRocmVhdE1vZGUgPyAwIDogMTtcbiAgICBpZiAodGhpcy53b3JrLnBseSAlIDIgPT09IHBpdm90KSBldiA9IC1ldjtcblxuICAgIC8vIEZvciBub3csIGlnbm9yZSBtb3N0IHVwcGVyYm91bmQvbG93ZXJib3VuZCBtZXNzYWdlcy5cbiAgICAvLyBUaGUgZXhjZXB0aW9uIGlzIGZvciBtdWx0aVBWLCBzb21ldGltZXMgbm9uLXByaW1hcnkgUFZzXG4gICAgLy8gb25seSBoYXZlIGFuIHVwcGVyYm91bmQuXG4gICAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZGR1Z292aWMvU3RvY2tmaXNoL2lzc3Vlcy8yMjhcbiAgICBpZiAoZXZhbFR5cGUgJiYgbXVsdGlQdiA9PT0gMSkgcmV0dXJuO1xuXG4gICAgbGV0IHB2RGF0YSA9IHtcbiAgICAgIG1vdmVzLFxuICAgICAgY3A6IGlzTWF0ZSA/IHVuZGVmaW5lZCA6IGV2LFxuICAgICAgbWF0ZTogaXNNYXRlID8gZXYgOiB1bmRlZmluZWQsXG4gICAgICBkZXB0aCxcbiAgICB9O1xuXG4gICAgaWYgKG11bHRpUHYgPT09IDEpIHtcbiAgICAgIHRoaXMuY3VyRXZhbCA9IHtcbiAgICAgICAgZmVuOiB0aGlzLndvcmsuY3VycmVudEZlbixcbiAgICAgICAgbWF4RGVwdGg6IHRoaXMud29yay5tYXhEZXB0aCxcbiAgICAgICAgZGVwdGgsXG4gICAgICAgIGtucHM6IG5vZGVzIC8gZWxhcHNlZE1zLFxuICAgICAgICBub2RlcyxcbiAgICAgICAgY3A6IGlzTWF0ZSA/IHVuZGVmaW5lZCA6IGV2LFxuICAgICAgICBtYXRlOiBpc01hdGUgPyBldiA6IHVuZGVmaW5lZCxcbiAgICAgICAgcHZzOiBbcHZEYXRhXSxcbiAgICAgICAgbWlsbGlzOiBlbGFwc2VkTXNcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh0aGlzLmN1ckV2YWwpIHtcbiAgICAgIHRoaXMuY3VyRXZhbC5wdnMucHVzaChwdkRhdGEpO1xuICAgICAgdGhpcy5jdXJFdmFsLmRlcHRoID0gTWF0aC5taW4odGhpcy5jdXJFdmFsLmRlcHRoLCBkZXB0aCk7XG4gICAgfVxuXG4gICAgaWYgKG11bHRpUHYgPT09IHRoaXMuZXhwZWN0ZWRQdnMgJiYgdGhpcy5jdXJFdmFsKSB7XG4gICAgICB0aGlzLndvcmsuZW1pdCh0aGlzLmN1ckV2YWwpO1xuICAgIH1cbiAgfVxuXG4gIHN0YXJ0KHc6IFdvcmspIHtcbiAgICBpZiAoIXRoaXMuc3RvcHBlZCkge1xuICAgICAgLy8gVE9ETzogV29yayBpcyBzdGFydGVkIGJ5IGJhc2ljYWxseSBkb2luZyBzdG9wKCkudGhlbigoKSA9PiBzdGFydCh3KSkuXG4gICAgICAvLyBUaGVyZSBpcyBhIHJhY2UgY29uZGl0aW9uIHdoZXJlIG11bHRpcGxlIGNhbGxlcnMgYXJlIHdhaXRpbmcgZm9yXG4gICAgICAvLyBjb21wbGV0aW9uIG9mIHRoZSBzYW1lIHN0b3AgZnV0dXJlLCBhbmQgc28gdGhleSB3aWxsIHN0YXJ0IHdvcmsgYXRcbiAgICAgIC8vIHRoZSBzYW1lIHRpbWUuXG4gICAgICAvLyBUaGlzIGNhbiBsZWFkIHRvIGFsbCBraW5kcyBvZiBpc3N1ZXMsIGluY2x1ZGluZyBkZWFkbG9ja3MuIEluc3RlYWRcbiAgICAgIC8vIHdlIGlnbm9yZSBhbGwgYnV0IHRoZSBmaXJzdCByZXF1ZXN0LiBUaGUgZW5naW5lIHdpbGwgc2hvdyBhcyBsb2FkaW5nXG4gICAgICAvLyBpbmRlZmluaXRlbHkuIFVudGlsIHRoaXMgaXMgZml4ZWQsIGl0IGlzIHN0aWxsIGJldHRlciB0aGFuIGFcbiAgICAgIC8vIHBvc3NpYmxlIGRlYWRsb2NrLlxuICAgICAgY29uc29sZS5sb2coJ2NldmFsOiB0cmllZCB0byBzdGFydCBhbmFseXNpbmcgYmVmb3JlIHJlcXVlc3Rpbmcgc3RvcCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLndvcmsgPSB3O1xuICAgIHRoaXMuY3VyRXZhbCA9IG51bGw7XG4gICAgdGhpcy5zdG9wcGVkID0gbnVsbDtcbiAgICB0aGlzLmV4cGVjdGVkUHZzID0gMTtcbiAgICBpZiAodGhpcy5vcHRzLnRocmVhZHMpIHRoaXMuc2V0T3B0aW9uKCdUaHJlYWRzJywgdGhpcy5vcHRzLnRocmVhZHMoKSk7XG4gICAgaWYgKHRoaXMub3B0cy5oYXNoU2l6ZSkgdGhpcy5zZXRPcHRpb24oJ0hhc2gnLCB0aGlzLm9wdHMuaGFzaFNpemUoKSk7XG4gICAgdGhpcy5zZXRPcHRpb24oJ011bHRpUFYnLCB0aGlzLndvcmsubXVsdGlQdik7XG4gICAgdGhpcy5zZW5kKFsncG9zaXRpb24nLCAnZmVuJywgdGhpcy53b3JrLmluaXRpYWxGZW4sICdtb3ZlcyddLmNvbmNhdCh0aGlzLndvcmsubW92ZXMpLmpvaW4oJyAnKSk7XG4gICAgaWYgKHRoaXMud29yay5tYXhEZXB0aCA+PSA5OSkgdGhpcy5zZW5kKCdnbyBkZXB0aCA5OScpO1xuICAgIGVsc2UgdGhpcy5zZW5kKCdnbyBtb3ZldGltZSA5MDAwMCBkZXB0aCAnICsgdGhpcy53b3JrLm1heERlcHRoKTtcbiAgfVxuXG4gIHN0b3AoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLnN0b3BwZWQpIHtcbiAgICAgIHRoaXMud29yayA9IG51bGw7XG4gICAgICB0aGlzLnN0b3BwZWQgPSBkZWZlcjx2b2lkPigpO1xuICAgICAgdGhpcy5zZW5kKCdzdG9wJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnN0b3BwZWQucHJvbWlzZTtcbiAgfVxuXG4gIGlzQ29tcHV0aW5nKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5zdG9wcGVkO1xuICB9XG59O1xuXG5mdW5jdGlvbiBkZWZlcjxBPigpOiBEZWZlclByb21pc2UuRGVmZXJyZWQ8QT4ge1xuICBjb25zdCBkZWZlcnJlZDogUGFydGlhbDxEZWZlclByb21pc2UuRGVmZXJyZWQ8QT4+ID0ge31cbiAgZGVmZXJyZWQucHJvbWlzZSA9IG5ldyBQcm9taXNlPEE+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICBkZWZlcnJlZC5yZXNvbHZlID0gcmVzb2x2ZVxuICAgIGRlZmVycmVkLnJlamVjdCA9IHJlamVjdFxuICB9KVxuICByZXR1cm4gZGVmZXJyZWQgYXMgRGVmZXJQcm9taXNlLkRlZmVycmVkPEE+O1xufVxuIl19