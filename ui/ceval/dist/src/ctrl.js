"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const pool_1 = require("./pool");
const common_1 = require("common");
const storage_1 = require("common/storage");
const throttle_1 = require("common/throttle");
const winningChances_1 = require("./winningChances");
const li = window.lichess;
function sanIrreversible(variant, san) {
    if (san.startsWith('O-O'))
        return true;
    if (variant === 'crazyhouse')
        return false;
    if (san.includes('x'))
        return true; // capture
    if (san.toLowerCase() === san)
        return true; // pawn move
    return variant === 'threeCheck' && san.includes('+');
}
function officialStockfish(variant) {
    return variant === 'standard' || variant === 'chess960';
}
function is64Bit() {
    const x64 = ['x86_64', 'x86-64', 'Win64', 'x64', 'amd64', 'AMD64'];
    for (const substr of x64)
        if (navigator.userAgent.includes(substr))
            return true;
    return navigator.platform === 'Linux x86_64' || navigator.platform === 'MacIntel';
}
function sharedWasmMemory(initial, maximum) {
    // In theory 32 bit should be supported just the same, but some 32 bit
    // browser builds seem to have trouble with WASMX. So for now detect and
    // require a 64 bit platform.
    if (!is64Bit())
        return;
    // Atomics
    if (typeof Atomics !== 'object')
        return;
    // SharedArrayBuffer
    if (typeof SharedArrayBuffer !== 'function')
        return;
    // Shared memory
    const mem = new WebAssembly.Memory({ shared: true, initial, maximum });
    if (!(mem.buffer instanceof SharedArrayBuffer))
        return;
    // Structured cloning
    try {
        window.postMessage(mem, '*');
    }
    catch (e) {
        return;
    }
    return mem;
}
function median(values) {
    values.sort((a, b) => a - b);
    const half = Math.floor(values.length / 2);
    return values.length % 2 ? values[half] : (values[half - 1] + values[half]) / 2.0;
}
function default_1(opts) {
    const storageKey = (k) => {
        return opts.storageKeyPrefix ? `${opts.storageKeyPrefix}.${k}` : k;
    };
    // select wasmx with growable shared mem > wasmx > wasm > asmjs
    let technology = 'asmjs';
    let growableSharedMem = false;
    if (typeof WebAssembly === 'object' && WebAssembly.validate(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00))) {
        technology = 'wasm'; // WebAssembly 1.0
        if (officialStockfish(opts.variant.key)) {
            const sharedMem = sharedWasmMemory(8, 16);
            if (sharedMem) {
                technology = 'wasmx';
                try {
                    sharedMem.grow(8);
                    growableSharedMem = true;
                }
                catch (e) { }
            }
        }
    }
    const maxThreads = Math.min(Math.max((navigator.hardwareConcurrency || 1) - 1, 1), growableSharedMem ? 16 : 2);
    const threads = storage_1.storedProp(storageKey('ceval.threads'), Math.min(Math.ceil((navigator.hardwareConcurrency || 1) / 4), maxThreads));
    const maxHashSize = Math.min((navigator.deviceMemory || 0.25) * 1024 / 8, growableSharedMem ? 1024 : 16);
    const hashSize = storage_1.storedProp(storageKey('ceval.hash-size'), 16);
    const minDepth = 6;
    const maxDepth = storage_1.storedProp(storageKey('ceval.max-depth'), 18);
    const multiPv = storage_1.storedProp(storageKey('ceval.multipv'), opts.multiPvDefault || 1);
    const infinite = storage_1.storedProp('ceval.infinite', false);
    let curEval = null;
    const enableStorage = li.storage.makeBoolean(storageKey('client-eval-enabled'));
    const allowed = common_1.prop(true);
    const enabled = common_1.prop(opts.possible && allowed() && enableStorage.get() && !document.hidden);
    let started = false;
    let lastStarted = false; // last started object (for going deeper even if stopped)
    const hovering = common_1.prop(null);
    const isDeeper = common_1.prop(false);
    const pool = new pool_1.Pool({
        technology,
        asmjs: 'vendor/stockfish.js/stockfish.js',
        wasm: 'vendor/stockfish.js/stockfish.wasm.js',
        wasmx: officialStockfish(opts.variant.key) ? 'vendor/stockfish.wasm/stockfish.js' : 'vendor/stockfish-mv.wasm/stockfish.js',
    }, {
        minDepth,
        variant: opts.variant.key,
        threads: technology == 'wasmx' && (() => Math.min(parseInt(threads()), maxThreads)),
        hashSize: technology == 'wasmx' && (() => Math.min(parseInt(hashSize()), maxHashSize)),
    });
    // adjusts maxDepth based on nodes per second
    const npsRecorder = (function () {
        const values = [];
        const applies = function (ev) {
            return ev.knps && ev.depth >= 16 &&
                typeof ev.cp !== 'undefined' && Math.abs(ev.cp) < 500 &&
                (ev.fen.split(/\s/)[0].split(/[nbrqkp]/i).length - 1) >= 10;
        };
        return function (ev) {
            if (!applies(ev))
                return;
            values.push(ev.knps);
            if (values.length > 9) {
                let depth = 18, knps = median(values) || 0;
                if (knps > 100)
                    depth = 19;
                if (knps > 150)
                    depth = 20;
                if (knps > 250)
                    depth = 21;
                if (knps > 500)
                    depth = 22;
                if (knps > 1000)
                    depth = 23;
                if (knps > 2000)
                    depth = 24;
                if (knps > 3500)
                    depth = 25;
                if (knps > 5000)
                    depth = 26;
                if (knps > 7000)
                    depth = 27;
                maxDepth(depth);
                if (values.length > 40)
                    values.shift();
            }
        };
    })();
    let lastEmitFen = null;
    const onEmit = throttle_1.default(200, (ev, work) => {
        sortPvsInPlace(ev.pvs, (work.ply % 2 === (work.threatMode ? 1 : 0)) ? 'white' : 'black');
        npsRecorder(ev);
        curEval = ev;
        opts.emit(ev, work);
        if (ev.fen !== lastEmitFen) {
            lastEmitFen = ev.fen;
            li.storage.fire('ceval.fen', ev.fen);
        }
    });
    const effectiveMaxDepth = () => (isDeeper() || infinite()) ? 99 : parseInt(maxDepth());
    const sortPvsInPlace = (pvs, color) => pvs.sort(function (a, b) {
        return winningChances_1.povChances(color, b) - winningChances_1.povChances(color, a);
    });
    const start = (path, steps, threatMode, deeper) => {
        if (!enabled() || !opts.possible)
            return;
        isDeeper(deeper);
        const maxD = effectiveMaxDepth();
        const step = steps[steps.length - 1];
        const existing = threatMode ? step.threat : step.ceval;
        if (existing && existing.depth >= maxD)
            return;
        const work = {
            initialFen: steps[0].fen,
            moves: [],
            currentFen: step.fen,
            path,
            ply: step.ply,
            maxDepth: maxD,
            multiPv: parseInt(multiPv()),
            threatMode,
            emit(ev) {
                if (enabled())
                    onEmit(ev, work);
            }
        };
        if (threatMode) {
            const c = step.ply % 2 === 1 ? 'w' : 'b';
            const fen = step.fen.replace(/ (w|b) /, ' ' + c + ' ');
            work.currentFen = fen;
            work.initialFen = fen;
        }
        else {
            // send fen after latest castling move and the following moves
            for (let i = 1; i < steps.length; i++) {
                let s = steps[i];
                if (sanIrreversible(opts.variant.key, s.san)) {
                    work.moves = [];
                    work.initialFen = s.fen;
                }
                else
                    work.moves.push(s.uci);
            }
        }
        pool.start(work);
        started = {
            path,
            steps,
            threatMode
        };
    };
    function goDeeper() {
        const s = started || lastStarted;
        if (s) {
            stop();
            start(s.path, s.steps, s.threatMode, true);
        }
    }
    ;
    function stop() {
        if (!enabled() || !started)
            return;
        pool.stop();
        lastStarted = started;
        started = false;
    }
    ;
    // ask other tabs if a game is in progress
    if (enabled()) {
        li.storage.fire('ceval.fen', 'start');
        li.storage.make('round.ongoing').listen(_ => {
            enabled(false);
            opts.redraw();
        });
    }
    return {
        technology,
        start,
        stop,
        allowed,
        possible: opts.possible,
        enabled,
        multiPv,
        threads: technology == 'wasmx' ? threads : undefined,
        hashSize: technology == 'wasmx' ? hashSize : undefined,
        maxThreads,
        maxHashSize,
        infinite,
        hovering,
        setHovering(fen, uci) {
            hovering(uci ? {
                fen,
                uci
            } : null);
            opts.setAutoShapes();
        },
        toggle() {
            if (!opts.possible || !allowed())
                return;
            stop();
            enabled(!enabled());
            if (document.visibilityState !== 'hidden')
                enableStorage.set(enabled());
        },
        curDepth: () => curEval ? curEval.depth : 0,
        effectiveMaxDepth,
        variant: opts.variant,
        isDeeper,
        goDeeper,
        canGoDeeper: () => !isDeeper() && !infinite() && !pool.isComputing(),
        isComputing: () => !!started && pool.isComputing(),
        engineName: pool.engineName,
        destroy: pool.destroy,
        redraw: opts.redraw
    };
}
exports.default = default_1;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3RybC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jdHJsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsaUNBQThCO0FBQzlCLG1DQUE4QjtBQUM5Qiw0Q0FBNEM7QUFDNUMsOENBQXVDO0FBQ3ZDLHFEQUE4QztBQUU5QyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO0FBRTFCLFNBQVMsZUFBZSxDQUFDLE9BQW1CLEVBQUUsR0FBVztJQUN2RCxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDdkMsSUFBSSxPQUFPLEtBQUssWUFBWTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQzNDLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7UUFBRSxPQUFPLElBQUksQ0FBQyxDQUFDLFVBQVU7SUFDOUMsSUFBSSxHQUFHLENBQUMsV0FBVyxFQUFFLEtBQUssR0FBRztRQUFFLE9BQU8sSUFBSSxDQUFDLENBQUMsWUFBWTtJQUN4RCxPQUFPLE9BQU8sS0FBSyxZQUFZLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2RCxDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxPQUFtQjtJQUM1QyxPQUFPLE9BQU8sS0FBSyxVQUFVLElBQUksT0FBTyxLQUFLLFVBQVUsQ0FBQztBQUMxRCxDQUFDO0FBRUQsU0FBUyxPQUFPO0lBQ2QsTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xFLEtBQUssTUFBTSxNQUFNLElBQUksR0FBRztRQUFFLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQUUsT0FBTyxJQUFJLENBQUM7SUFDaEYsT0FBTyxTQUFTLENBQUMsUUFBUSxLQUFLLGNB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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENldmFsQ3RybCwgQ2V2YWxPcHRzLCBDZXZhbFRlY2hub2xvZ3ksIFdvcmssIFN0ZXAsIEhvdmVyaW5nLCBTdGFydGVkIH0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB7IFBvb2wgfSBmcm9tICcuL3Bvb2wnO1xuaW1wb3J0IHsgcHJvcCB9IGZyb20gJ2NvbW1vbic7XG5pbXBvcnQgeyBzdG9yZWRQcm9wIH0gZnJvbSAnY29tbW9uL3N0b3JhZ2UnO1xuaW1wb3J0IHRocm90dGxlIGZyb20gJ2NvbW1vbi90aHJvdHRsZSc7XG5pbXBvcnQgeyBwb3ZDaGFuY2VzIH0gZnJvbSAnLi93aW5uaW5nQ2hhbmNlcyc7XG5cbmNvbnN0IGxpID0gd2luZG93LmxpY2hlc3M7XG5cbmZ1bmN0aW9uIHNhbklycmV2ZXJzaWJsZSh2YXJpYW50OiBWYXJpYW50S2V5LCBzYW46IHN0cmluZyk6IGJvb2xlYW4ge1xuICBpZiAoc2FuLnN0YXJ0c1dpdGgoJ08tTycpKSByZXR1cm4gdHJ1ZTtcbiAgaWYgKHZhcmlhbnQgPT09ICdjcmF6eWhvdXNlJykgcmV0dXJuIGZhbHNlO1xuICBpZiAoc2FuLmluY2x1ZGVzKCd4JykpIHJldHVybiB0cnVlOyAvLyBjYXB0dXJlXG4gIGlmIChzYW4udG9Mb3dlckNhc2UoKSA9PT0gc2FuKSByZXR1cm4gdHJ1ZTsgLy8gcGF3biBtb3ZlXG4gIHJldHVybiB2YXJpYW50ID09PSAndGhyZWVDaGVjaycgJiYgc2FuLmluY2x1ZGVzKCcrJyk7XG59XG5cbmZ1bmN0aW9uIG9mZmljaWFsU3RvY2tmaXNoKHZhcmlhbnQ6IFZhcmlhbnRLZXkpOiBib29sZWFuIHtcbiAgcmV0dXJuIHZhcmlhbnQgPT09ICdzdGFuZGFyZCcgfHwgdmFyaWFudCA9PT0gJ2NoZXNzOTYwJztcbn1cblxuZnVuY3Rpb24gaXM2NEJpdCgpOiBib29sZWFuIHtcbiAgY29uc3QgeDY0ID0gWyd4ODZfNjQnLCAneDg2LTY0JywgJ1dpbjY0JywneDY0JywgJ2FtZDY0JywgJ0FNRDY0J107XG4gIGZvciAoY29uc3Qgc3Vic3RyIG9mIHg2NCkgaWYgKG5hdmlnYXRvci51c2VyQWdlbnQuaW5jbHVkZXMoc3Vic3RyKSkgcmV0dXJuIHRydWU7XG4gIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm0gPT09ICdMaW51eCB4ODZfNjQnIHx8IG5hdmlnYXRvci5wbGF0Zm9ybSA9PT0gJ01hY0ludGVsJztcbn1cblxuZnVuY3Rpb24gc2hhcmVkV2FzbU1lbW9yeShpbml0aWFsOiBudW1iZXIsIG1heGltdW06IG51bWJlcik6IFdlYkFzc2VtYmx5Lk1lbW9yeSB8IHVuZGVmaW5lZCB7XG4gIC8vIEluIHRoZW9yeSAzMiBiaXQgc2hvdWxkIGJlIHN1cHBvcnRlZCBqdXN0IHRoZSBzYW1lLCBidXQgc29tZSAzMiBiaXRcbiAgLy8gYnJvd3NlciBidWlsZHMgc2VlbSB0byBoYXZlIHRyb3VibGUgd2l0aCBXQVNNWC4gU28gZm9yIG5vdyBkZXRlY3QgYW5kXG4gIC8vIHJlcXVpcmUgYSA2NCBiaXQgcGxhdGZvcm0uXG4gIGlmICghaXM2NEJpdCgpKSByZXR1cm47XG5cbiAgLy8gQXRvbWljc1xuICBpZiAodHlwZW9mIEF0b21pY3MgIT09ICdvYmplY3QnKSByZXR1cm47XG5cbiAgLy8gU2hhcmVkQXJyYXlCdWZmZXJcbiAgaWYgKHR5cGVvZiBTaGFyZWRBcnJheUJ1ZmZlciAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuO1xuXG4gIC8vIFNoYXJlZCBtZW1vcnlcbiAgY29uc3QgbWVtID0gbmV3IFdlYkFzc2VtYmx5Lk1lbW9yeSh7c2hhcmVkOiB0cnVlLCBpbml0aWFsLCBtYXhpbXVtfSBhcyBXZWJBc3NlbWJseS5NZW1vcnlEZXNjcmlwdG9yKTtcbiAgaWYgKCEobWVtLmJ1ZmZlciBpbnN0YW5jZW9mIFNoYXJlZEFycmF5QnVmZmVyKSkgcmV0dXJuO1xuXG4gIC8vIFN0cnVjdHVyZWQgY2xvbmluZ1xuICB0cnkge1xuICAgIHdpbmRvdy5wb3N0TWVzc2FnZShtZW0sICcqJyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICByZXR1cm4gbWVtO1xufVxuXG5mdW5jdGlvbiBtZWRpYW4odmFsdWVzOiBudW1iZXJbXSk6IG51bWJlciB7XG4gIHZhbHVlcy5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gIGNvbnN0IGhhbGYgPSBNYXRoLmZsb29yKHZhbHVlcy5sZW5ndGggLyAyKTtcbiAgcmV0dXJuIHZhbHVlcy5sZW5ndGggJSAyID8gdmFsdWVzW2hhbGZdIDogKHZhbHVlc1toYWxmIC0gMV0gKyB2YWx1ZXNbaGFsZl0pIC8gMi4wO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihvcHRzOiBDZXZhbE9wdHMpOiBDZXZhbEN0cmwge1xuICBjb25zdCBzdG9yYWdlS2V5ID0gKGs6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiBvcHRzLnN0b3JhZ2VLZXlQcmVmaXggPyBgJHtvcHRzLnN0b3JhZ2VLZXlQcmVmaXh9LiR7a31gIDogaztcbiAgfTtcblxuICAvLyBzZWxlY3Qgd2FzbXggd2l0aCBncm93YWJsZSBzaGFyZWQgbWVtID4gd2FzbXggPiB3YXNtID4gYXNtanNcbiAgbGV0IHRlY2hub2xvZ3k6IENldmFsVGVjaG5vbG9neSA9ICdhc21qcyc7XG4gIGxldCBncm93YWJsZVNoYXJlZE1lbSA9IGZhbHNlO1xuICBpZiAodHlwZW9mIFdlYkFzc2VtYmx5ID09PSAnb2JqZWN0JyAmJiBXZWJBc3NlbWJseS52YWxpZGF0ZShVaW50OEFycmF5Lm9mKDB4MCwgMHg2MSwgMHg3MywgMHg2ZCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCkpKSB7XG4gICAgdGVjaG5vbG9neSA9ICd3YXNtJzsgLy8gV2ViQXNzZW1ibHkgMS4wXG4gICAgaWYgKG9mZmljaWFsU3RvY2tmaXNoKG9wdHMudmFyaWFudC5rZXkpKSB7XG4gICAgICBjb25zdCBzaGFyZWRNZW0gPSBzaGFyZWRXYXNtTWVtb3J5KDgsIDE2KTtcbiAgICAgIGlmIChzaGFyZWRNZW0pIHtcbiAgICAgICAgdGVjaG5vbG9neSA9ICd3YXNteCc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc2hhcmVkTWVtLmdyb3coOCk7XG4gICAgICAgICAgZ3Jvd2FibGVTaGFyZWRNZW0gPSB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlKSB7IH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBtYXhUaHJlYWRzID0gTWF0aC5taW4oTWF0aC5tYXgoKG5hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5IHx8IDEpIC0gMSwgMSksIGdyb3dhYmxlU2hhcmVkTWVtID8gMTYgOiAyKTtcbiAgY29uc3QgdGhyZWFkcyA9IHN0b3JlZFByb3Aoc3RvcmFnZUtleSgnY2V2YWwudGhyZWFkcycpLCBNYXRoLm1pbihNYXRoLmNlaWwoKG5hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5IHx8IDEpIC8gNCksIG1heFRocmVhZHMpKTtcblxuICBjb25zdCBtYXhIYXNoU2l6ZSA9IE1hdGgubWluKChuYXZpZ2F0b3IuZGV2aWNlTWVtb3J5IHx8IDAuMjUpICogMTAyNCAvIDgsIGdyb3dhYmxlU2hhcmVkTWVtID8gMTAyNCA6IDE2KTtcbiAgY29uc3QgaGFzaFNpemUgPSBzdG9yZWRQcm9wKHN0b3JhZ2VLZXkoJ2NldmFsLmhhc2gtc2l6ZScpLCAxNik7XG5cbiAgY29uc3QgbWluRGVwdGggPSA2O1xuICBjb25zdCBtYXhEZXB0aCA9IHN0b3JlZFByb3A8bnVtYmVyPihzdG9yYWdlS2V5KCdjZXZhbC5tYXgtZGVwdGgnKSwgMTgpO1xuICBjb25zdCBtdWx0aVB2ID0gc3RvcmVkUHJvcChzdG9yYWdlS2V5KCdjZXZhbC5tdWx0aXB2JyksIG9wdHMubXVsdGlQdkRlZmF1bHQgfHwgMSk7XG4gIGNvbnN0IGluZmluaXRlID0gc3RvcmVkUHJvcCgnY2V2YWwuaW5maW5pdGUnLCBmYWxzZSk7XG4gIGxldCBjdXJFdmFsOiBUcmVlLkNsaWVudEV2YWwgfCBudWxsID0gbnVsbDtcbiAgY29uc3QgZW5hYmxlU3RvcmFnZSA9IGxpLnN0b3JhZ2UubWFrZUJvb2xlYW4oc3RvcmFnZUtleSgnY2xpZW50LWV2YWwtZW5hYmxlZCcpKTtcbiAgY29uc3QgYWxsb3dlZCA9IHByb3AodHJ1ZSk7XG4gIGNvbnN0IGVuYWJsZWQgPSBwcm9wKG9wdHMucG9zc2libGUgJiYgYWxsb3dlZCgpICYmIGVuYWJsZVN0b3JhZ2UuZ2V0KCkgJiYgIWRvY3VtZW50LmhpZGRlbik7XG4gIGxldCBzdGFydGVkOiBTdGFydGVkIHwgZmFsc2UgPSBmYWxzZTtcbiAgbGV0IGxhc3RTdGFydGVkOiBTdGFydGVkIHwgZmFsc2UgPSBmYWxzZTsgLy8gbGFzdCBzdGFydGVkIG9iamVjdCAoZm9yIGdvaW5nIGRlZXBlciBldmVuIGlmIHN0b3BwZWQpXG4gIGNvbnN0IGhvdmVyaW5nID0gcHJvcDxIb3ZlcmluZyB8IG51bGw+KG51bGwpO1xuICBjb25zdCBpc0RlZXBlciA9IHByb3AoZmFsc2UpO1xuXG4gIGNvbnN0IHBvb2wgPSBuZXcgUG9vbCh7XG4gICAgdGVjaG5vbG9neSxcbiAgICBhc21qczogJ3ZlbmRvci9zdG9ja2Zpc2guanMvc3RvY2tmaXNoLmpzJyxcbiAgICB3YXNtOiAndmVuZG9yL3N0b2NrZmlzaC5qcy9zdG9ja2Zpc2gud2FzbS5qcycsXG4gICAgd2FzbXg6IG9mZmljaWFsU3RvY2tmaXNoKG9wdHMudmFyaWFudC5rZXkpID8gJ3ZlbmRvci9zdG9ja2Zpc2gud2FzbS9zdG9ja2Zpc2guanMnIDogJ3ZlbmRvci9zdG9ja2Zpc2gtbXYud2FzbS9zdG9ja2Zpc2guanMnLFxuICB9LCB7XG4gICAgbWluRGVwdGgsXG4gICAgdmFyaWFudDogb3B0cy52YXJpYW50LmtleSxcbiAgICB0aHJlYWRzOiB0ZWNobm9sb2d5ID09ICd3YXNteCcgJiYgKCgpID0+IE1hdGgubWluKHBhcnNlSW50KHRocmVhZHMoKSksIG1heFRocmVhZHMpKSxcbiAgICBoYXNoU2l6ZTogdGVjaG5vbG9neSA9PSAnd2FzbXgnICYmICgoKSA9PiBNYXRoLm1pbihwYXJzZUludChoYXNoU2l6ZSgpKSwgbWF4SGFzaFNpemUpKSxcbiAgfSk7XG5cbiAgLy8gYWRqdXN0cyBtYXhEZXB0aCBiYXNlZCBvbiBub2RlcyBwZXIgc2Vjb25kXG4gIGNvbnN0IG5wc1JlY29yZGVyID0gKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHZhbHVlczogbnVtYmVyW10gPSBbXTtcbiAgICBjb25zdCBhcHBsaWVzID0gZnVuY3Rpb24oZXY6IFRyZWUuQ2xpZW50RXZhbCkge1xuICAgICAgcmV0dXJuIGV2LmtucHMgJiYgZXYuZGVwdGggPj0gMTYgJiZcbiAgICAgICAgdHlwZW9mIGV2LmNwICE9PSAndW5kZWZpbmVkJyAmJiBNYXRoLmFicyhldi5jcCkgPCA1MDAgJiZcbiAgICAgICAgKGV2LmZlbi5zcGxpdCgvXFxzLylbMF0uc3BsaXQoL1tuYnJxa3BdL2kpLmxlbmd0aCAtIDEpID49IDEwO1xuICAgIH1cbiAgICByZXR1cm4gZnVuY3Rpb24oZXY6IFRyZWUuQ2xpZW50RXZhbCkge1xuICAgICAgaWYgKCFhcHBsaWVzKGV2KSkgcmV0dXJuO1xuICAgICAgdmFsdWVzLnB1c2goZXYua25wcyk7XG4gICAgICBpZiAodmFsdWVzLmxlbmd0aCA+IDkpIHtcbiAgICAgICAgbGV0IGRlcHRoID0gMTgsXG4gICAgICAgICAga25wcyA9IG1lZGlhbih2YWx1ZXMpIHx8IDA7XG4gICAgICAgIGlmIChrbnBzID4gMTAwKSBkZXB0aCA9IDE5O1xuICAgICAgICBpZiAoa25wcyA+IDE1MCkgZGVwdGggPSAyMDtcbiAgICAgICAgaWYgKGtucHMgPiAyNTApIGRlcHRoID0gMjE7XG4gICAgICAgIGlmIChrbnBzID4gNTAwKSBkZXB0aCA9IDIyO1xuICAgICAgICBpZiAoa25wcyA+IDEwMDApIGRlcHRoID0gMjM7XG4gICAgICAgIGlmIChrbnBzID4gMjAwMCkgZGVwdGggPSAyNDtcbiAgICAgICAgaWYgKGtucHMgPiAzNTAwKSBkZXB0aCA9IDI1O1xuICAgICAgICBpZiAoa25wcyA+IDUwMDApIGRlcHRoID0gMjY7XG4gICAgICAgIGlmIChrbnBzID4gNzAwMCkgZGVwdGggPSAyNztcbiAgICAgICAgbWF4RGVwdGgoZGVwdGgpO1xuICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCA+IDQwKSB2YWx1ZXMuc2hpZnQoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9KSgpO1xuXG4gIGxldCBsYXN0RW1pdEZlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3Qgb25FbWl0ID0gdGhyb3R0bGUoMjAwLCAoZXY6IFRyZWUuQ2xpZW50RXZhbCwgd29yazogV29yaykgPT4ge1xuICAgIHNvcnRQdnNJblBsYWNlKGV2LnB2cywgKHdvcmsucGx5ICUgMiA9PT0gKHdvcmsudGhyZWF0TW9kZSA/IDEgOiAwKSkgPyAnd2hpdGUnIDogJ2JsYWNrJyk7XG4gICAgbnBzUmVjb3JkZXIoZXYpO1xuICAgIGN1ckV2YWwgPSBldjtcbiAgICBvcHRzLmVtaXQoZXYsIHdvcmspO1xuICAgIGlmIChldi5mZW4gIT09IGxhc3RFbWl0RmVuKSB7XG4gICAgICBsYXN0RW1pdEZlbiA9IGV2LmZlbjtcbiAgICAgIGxpLnN0b3JhZ2UuZmlyZSgnY2V2YWwuZmVuJywgZXYuZmVuKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IGVmZmVjdGl2ZU1heERlcHRoID0gKCkgPT4gKGlzRGVlcGVyKCkgfHwgaW5maW5pdGUoKSkgPyA5OSA6IHBhcnNlSW50KG1heERlcHRoKCkpO1xuXG4gIGNvbnN0IHNvcnRQdnNJblBsYWNlID0gKHB2czogVHJlZS5QdkRhdGFbXSwgY29sb3I6IENvbG9yKSA9PlxuICAgIHB2cy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtcbiAgICAgIHJldHVybiBwb3ZDaGFuY2VzKGNvbG9yLCBiKSAtIHBvdkNoYW5jZXMoY29sb3IsIGEpO1xuICAgIH0pO1xuXG4gIGNvbnN0IHN0YXJ0ID0gKHBhdGg6IFRyZWUuUGF0aCwgc3RlcHM6IFN0ZXBbXSwgdGhyZWF0TW9kZTogYm9vbGVhbiwgZGVlcGVyOiBib29sZWFuKSA9PiB7XG5cbiAgICBpZiAoIWVuYWJsZWQoKSB8fCAhb3B0cy5wb3NzaWJsZSkgcmV0dXJuO1xuXG4gICAgaXNEZWVwZXIoZGVlcGVyKTtcbiAgICBjb25zdCBtYXhEID0gZWZmZWN0aXZlTWF4RGVwdGgoKTtcblxuICAgIGNvbnN0IHN0ZXAgPSBzdGVwc1tzdGVwcy5sZW5ndGggLSAxXTtcblxuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhyZWF0TW9kZSA/IHN0ZXAudGhyZWF0IDogc3RlcC5jZXZhbDtcbiAgICBpZiAoZXhpc3RpbmcgJiYgZXhpc3RpbmcuZGVwdGggPj0gbWF4RCkgcmV0dXJuO1xuXG4gICAgY29uc3Qgd29yazogV29yayA9IHtcbiAgICAgIGluaXRpYWxGZW46IHN0ZXBzWzBdLmZlbixcbiAgICAgIG1vdmVzOiBbXSxcbiAgICAgIGN1cnJlbnRGZW46IHN0ZXAuZmVuLFxuICAgICAgcGF0aCxcbiAgICAgIHBseTogc3RlcC5wbHksXG4gICAgICBtYXhEZXB0aDogbWF4RCxcbiAgICAgIG11bHRpUHY6IHBhcnNlSW50KG11bHRpUHYoKSksXG4gICAgICB0aHJlYXRNb2RlLFxuICAgICAgZW1pdChldjogVHJlZS5DbGllbnRFdmFsKSB7XG4gICAgICAgIGlmIChlbmFibGVkKCkpIG9uRW1pdChldiwgd29yayk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGlmICh0aHJlYXRNb2RlKSB7XG4gICAgICBjb25zdCBjID0gc3RlcC5wbHkgJSAyID09PSAxID8gJ3cnIDogJ2InO1xuICAgICAgY29uc3QgZmVuID0gc3RlcC5mZW4ucmVwbGFjZSgvICh3fGIpIC8sICcgJyArIGMgKyAnICcpO1xuICAgICAgd29yay5jdXJyZW50RmVuID0gZmVuO1xuICAgICAgd29yay5pbml0aWFsRmVuID0gZmVuO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBzZW5kIGZlbiBhZnRlciBsYXRlc3QgY2FzdGxpbmcgbW92ZSBhbmQgdGhlIGZvbGxvd2luZyBtb3Zlc1xuICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzdGVwcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBsZXQgcyA9IHN0ZXBzW2ldO1xuICAgICAgICBpZiAoc2FuSXJyZXZlcnNpYmxlKG9wdHMudmFyaWFudC5rZXksIHMuc2FuISkpIHtcbiAgICAgICAgICB3b3JrLm1vdmVzID0gW107XG4gICAgICAgICAgd29yay5pbml0aWFsRmVuID0gcy5mZW47XG4gICAgICAgIH0gZWxzZSB3b3JrLm1vdmVzLnB1c2gocy51Y2khKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBwb29sLnN0YXJ0KHdvcmspO1xuXG4gICAgc3RhcnRlZCA9IHtcbiAgICAgIHBhdGgsXG4gICAgICBzdGVwcyxcbiAgICAgIHRocmVhdE1vZGVcbiAgICB9O1xuICB9O1xuXG4gIGZ1bmN0aW9uIGdvRGVlcGVyKCkge1xuICAgIGNvbnN0IHMgPSBzdGFydGVkIHx8IGxhc3RTdGFydGVkO1xuICAgIGlmIChzKSB7XG4gICAgICBzdG9wKCk7XG4gICAgICBzdGFydChzLnBhdGgsIHMuc3RlcHMsIHMudGhyZWF0TW9kZSwgdHJ1ZSk7XG4gICAgfVxuICB9O1xuXG4gIGZ1bmN0aW9uIHN0b3AoKSB7XG4gICAgaWYgKCFlbmFibGVkKCkgfHwgIXN0YXJ0ZWQpIHJldHVybjtcbiAgICBwb29sLnN0b3AoKTtcbiAgICBsYXN0U3RhcnRlZCA9IHN0YXJ0ZWQ7XG4gICAgc3RhcnRlZCA9IGZhbHNlO1xuICB9O1xuXG4gIC8vIGFzayBvdGhlciB0YWJzIGlmIGEgZ2FtZSBpcyBpbiBwcm9ncmVzc1xuICBpZiAoZW5hYmxlZCgpKSB7XG4gICAgbGkuc3RvcmFnZS5maXJlKCdjZXZhbC5mZW4nLCAnc3RhcnQnKTtcbiAgICBsaS5zdG9yYWdlLm1ha2UoJ3JvdW5kLm9uZ29pbmcnKS5saXN0ZW4oXyA9PiB7XG4gICAgICBlbmFibGVkKGZhbHNlKTtcbiAgICAgIG9wdHMucmVkcmF3KCk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHRlY2hub2xvZ3ksXG4gICAgc3RhcnQsXG4gICAgc3RvcCxcbiAgICBhbGxvd2VkLFxuICAgIHBvc3NpYmxlOiBvcHRzLnBvc3NpYmxlLFxuICAgIGVuYWJsZWQsXG4gICAgbXVsdGlQdixcbiAgICB0aHJlYWRzOiB0ZWNobm9sb2d5ID09ICd3YXNteCcgPyB0aHJlYWRzIDogdW5kZWZpbmVkLFxuICAgIGhhc2hTaXplOiB0ZWNobm9sb2d5ID09ICd3YXNteCcgPyBoYXNoU2l6ZSA6IHVuZGVmaW5lZCxcbiAgICBtYXhUaHJlYWRzLFxuICAgIG1heEhhc2hTaXplLFxuICAgIGluZmluaXRlLFxuICAgIGhvdmVyaW5nLFxuICAgIHNldEhvdmVyaW5nKGZlbjogRmVuLCB1Y2k/OiBVY2kpIHtcbiAgICAgIGhvdmVyaW5nKHVjaSA/IHtcbiAgICAgICAgZmVuLFxuICAgICAgICB1Y2lcbiAgICAgIH0gOiBudWxsKTtcbiAgICAgIG9wdHMuc2V0QXV0b1NoYXBlcygpO1xuICAgIH0sXG4gICAgdG9nZ2xlKCkge1xuICAgICAgaWYgKCFvcHRzLnBvc3NpYmxlIHx8ICFhbGxvd2VkKCkpIHJldHVybjtcbiAgICAgIHN0b3AoKTtcbiAgICAgIGVuYWJsZWQoIWVuYWJsZWQoKSk7XG4gICAgICBpZiAoZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlICE9PSAnaGlkZGVuJylcbiAgICAgICAgZW5hYmxlU3RvcmFnZS5zZXQoZW5hYmxlZCgpKTtcbiAgICB9LFxuICAgIGN1ckRlcHRoOiAoKSA9PiBjdXJFdmFsID8gY3VyRXZhbC5kZXB0aCA6IDAsXG4gICAgZWZmZWN0aXZlTWF4RGVwdGgsXG4gICAgdmFyaWFudDogb3B0cy52YXJpYW50LFxuICAgIGlzRGVlcGVyLFxuICAgIGdvRGVlcGVyLFxuICAgIGNhbkdvRGVlcGVyOiAoKSA9PiAhaXNEZWVwZXIoKSAmJiAhaW5maW5pdGUoKSAmJiAhcG9vbC5pc0NvbXB1dGluZygpLFxuICAgIGlzQ29tcHV0aW5nOiAoKSA9PiAhIXN0YXJ0ZWQgJiYgcG9vbC5pc0NvbXB1dGluZygpLFxuICAgIGVuZ2luZU5hbWU6IHBvb2wuZW5naW5lTmFtZSxcbiAgICBkZXN0cm95OiBwb29sLmRlc3Ryb3ksXG4gICAgcmVkcmF3OiBvcHRzLnJlZHJhd1xuICB9O1xufTtcbiJdfQ==