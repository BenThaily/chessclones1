"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const sync_1 = require("common/sync");
const stockfishProtocol_1 = require("./stockfishProtocol");
class AbstractWorker {
    constructor(url, poolOpts, workerOpts) {
        this.url = url;
        this.poolOpts = poolOpts;
        this.workerOpts = workerOpts;
        this.isComputing = () => !!this.protocol.sync && this.protocol.sync.isComputing();
        this.engineName = () => this.protocol.sync && this.protocol.sync.engineName;
        this.protocol = sync_1.sync(this.boot());
    }
    stop() {
        return this.protocol.promise.then(protocol => protocol.stop());
    }
    start(work) {
        return this.protocol.promise.then(protocol => {
            return protocol.stop().then(() => protocol.start(work));
        });
    }
}
exports.AbstractWorker = AbstractWorker;
class WebWorker extends AbstractWorker {
    boot() {
        this.worker = new Worker(window.lichess.assetUrl(this.url, { sameDomain: true }));
        const protocol = new stockfishProtocol_1.default(this.send.bind(this), this.workerOpts);
        this.worker.addEventListener('message', e => {
            protocol.received(e.data);
        }, true);
        return Promise.resolve(protocol);
    }
    start(work) {
        // wait for boot
        return this.protocol.promise.then(protocol => {
            const timeout = new Promise((_, reject) => setTimeout(reject, 1000));
            return Promise.race([protocol.stop(), timeout]).catch(() => {
                // reboot if not stopped after 1s
                this.destroy();
                this.protocol = sync_1.sync(this.boot());
            }).then(() => {
                return this.protocol.promise.then(protocol => protocol.start(work));
            });
        });
    }
    destroy() {
        this.worker.terminate();
    }
    send(cmd) {
        this.worker.postMessage(cmd);
    }
}
class ThreadedWasmWorker extends AbstractWorker {
    boot() {
        if (!ThreadedWasmWorker.global)
            ThreadedWasmWorker.global = window.lichess.loadScript(this.url, { sameDomain: true }).then(() => {
                const instance = this.instance = window['Stockfish'](), protocol = new stockfishProtocol_1.default(this.send.bind(this), this.workerOpts), listener = protocol.received.bind(protocol);
                instance.addMessageListener(listener);
                return {
                    instance,
                    protocol
                };
            });
        return ThreadedWasmWorker.global.then(global => {
            this.instance = global.instance;
            return global.protocol;
        });
    }
    destroy() {
        if (ThreadedWasmWorker.global) {
            console.log('stopping singleton wasmx worker (instead of destroying) ...');
            this.stop().then(() => console.log('... successfully stopped'));
        }
    }
    send(cmd) {
        if (this.instance)
            this.instance.postMessage(cmd);
    }
}
class Pool {
    constructor(poolOpts, protocolOpts) {
        this.poolOpts = poolOpts;
        this.protocolOpts = protocolOpts;
        this.workers = [];
        this.token = 0;
        this.warmup = () => {
            if (this.workers.length)
                return;
            if (this.poolOpts.technology == 'wasmx')
                this.workers.push(new ThreadedWasmWorker(this.poolOpts.wasmx, this.poolOpts, this.protocolOpts));
            else {
                for (let i = 1; i <= 2; i++)
                    this.workers.push(new WebWorker(this.poolOpts.technology == 'wasm' ? this.poolOpts.wasm : this.poolOpts.asmjs, this.poolOpts, this.protocolOpts));
            }
        };
        this.stop = () => this.workers.forEach(w => w.stop());
        this.destroy = () => {
            this.stop();
            this.workers.forEach(w => w.destroy());
        };
        this.start = (work) => {
            window.lichess.storage.fire('ceval.pool.start');
            this.getWorker().then(function (worker) {
                worker.start(work);
            }).catch(function (error) {
                console.log(error);
                setTimeout(() => window.lichess.reload(), 10000);
            });
        };
        this.isComputing = () => !!this.workers.length && this.workers[this.token].isComputing();
        this.engineName = () => this.workers[this.token] && this.workers[this.token].engineName();
    }
    getWorker() {
        this.warmup();
        // briefly wait and give a chance to reuse the current worker
        const worker = new Promise((resolve, reject) => {
            const currentWorker = this.workers[this.token];
            currentWorker.stop().then(() => resolve(currentWorker));
            setTimeout(reject, 50);
        });
        return worker.catch(() => {
            this.token = (this.token + 1) % this.workers.length;
            return Promise.resolve(this.workers[this.token]);
        });
    }
}
exports.Pool = Pool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wb29sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQXlDO0FBRXpDLDJEQUEyQztBQUUzQyxNQUFzQixjQUFjO0lBSWxDLFlBQXNCLEdBQVcsRUFBWSxRQUFrQixFQUFZLFVBQXNCO1FBQTNFLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFBWSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVksZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQWNqRyxnQkFBVyxHQUFrQixHQUFHLEVBQUUsQ0FDaEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRTNELGVBQVUsR0FBNkIsR0FBRyxFQUFFLENBQzFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQWpCcEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxXQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELElBQUk7UUFDRixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBVTtRQUNkLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzNDLE9BQU8sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NB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QztJQUNMLENBQUM7Q0FtQ0Y7QUF2REQsb0JBdURDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3luYywgU3luYyB9IGZyb20gJ2NvbW1vbi9zeW5jJztcbmltcG9ydCB7IFBvb2xPcHRzLCBXb3JrZXJPcHRzLCBXb3JrIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgUHJvdG9jb2wgZnJvbSAnLi9zdG9ja2Zpc2hQcm90b2NvbCc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBYnN0cmFjdFdvcmtlciB7XG5cbiAgcHJvdGVjdGVkIHByb3RvY29sOiBTeW5jPFByb3RvY29sPjtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgdXJsOiBzdHJpbmcsIHByb3RlY3RlZCBwb29sT3B0czogUG9vbE9wdHMsIHByb3RlY3RlZCB3b3JrZXJPcHRzOiBXb3JrZXJPcHRzKSB7XG4gICAgdGhpcy5wcm90b2NvbCA9IHN5bmModGhpcy5ib290KCkpO1xuICB9XG5cbiAgc3RvcCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5wcm90b2NvbC5wcm9taXNlLnRoZW4ocHJvdG9jb2wgPT4gcHJvdG9jb2wuc3RvcCgpKTtcbiAgfVxuXG4gIHN0YXJ0KHdvcms6IFdvcmspOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5wcm90b2NvbC5wcm9taXNlLnRoZW4ocHJvdG9jb2wgPT4ge1xuICAgICAgcmV0dXJuIHByb3RvY29sLnN0b3AoKS50aGVuKCgpID0+IHByb3RvY29sLnN0YXJ0KHdvcmspKTtcbiAgICB9KTtcbiAgfVxuXG4gIGlzQ29tcHV0aW5nOiAoKSA9PiBib29sZWFuID0gKCkgPT5cbiAgICAhIXRoaXMucHJvdG9jb2wuc3luYyAmJiB0aGlzLnByb3RvY29sLnN5bmMuaXNDb21wdXRpbmcoKTtcblxuICBlbmdpbmVOYW1lOiAoKSA9PiBzdHJpbmcgfCB1bmRlZmluZWQgPSAoKSA9PlxuICAgIHRoaXMucHJvdG9jb2wuc3luYyAmJiB0aGlzLnByb3RvY29sLnN5bmMuZW5naW5lTmFtZTtcblxuICBhYnN0cmFjdCBib290KCk6IFByb21pc2U8UHJvdG9jb2w+O1xuICBhYnN0cmFjdCBzZW5kKGNtZDogc3RyaW5nKTogdm9pZDtcbiAgYWJzdHJhY3QgZGVzdHJveSgpOiB2b2lkO1xufVxuXG5jbGFzcyBXZWJXb3JrZXIgZXh0ZW5kcyBBYnN0cmFjdFdvcmtlciB7XG4gIHdvcmtlcjogV29ya2VyO1xuXG4gIGJvb3QoKTogUHJvbWlzZTxQcm90b2NvbD4ge1xuICAgIHRoaXMud29ya2VyID0gbmV3IFdvcmtlcih3aW5kb3cubGljaGVzcy5hc3NldFVybCh0aGlzLnVybCwge3NhbWVEb21haW46IHRydWV9KSk7XG4gICAgY29uc3QgcHJvdG9jb2wgPSBuZXcgUHJvdG9jb2wodGhpcy5zZW5kLmJpbmQodGhpcyksIHRoaXMud29ya2VyT3B0cyk7XG4gICAgdGhpcy53b3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4ge1xuICAgICAgcHJvdG9jb2wucmVjZWl2ZWQoZS5kYXRhKTtcbiAgICB9LCB0cnVlKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHByb3RvY29sKTtcbiAgfVxuXG4gIHN0YXJ0KHdvcms6IFdvcmspOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyB3YWl0IGZvciBib290XG4gICAgcmV0dXJuIHRoaXMucHJvdG9jb2wucHJvbWlzZS50aGVuKHByb3RvY29sID0+IHtcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiBzZXRUaW1lb3V0KHJlamVjdCwgMTAwMCkpO1xuICAgICAgcmV0dXJuIFByb21pc2UucmFjZShbcHJvdG9jb2wuc3RvcCgpLCB0aW1lb3V0XSkuY2F0Y2goKCkgPT4ge1xuICAgICAgICAvLyByZWJvb3QgaWYgbm90IHN0b3BwZWQgYWZ0ZXIgMXNcbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMucHJvdG9jb2wgPSBzeW5jKHRoaXMuYm9vdCgpKTtcbiAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm90b2NvbC5wcm9taXNlLnRoZW4ocHJvdG9jb2wgPT4gcHJvdG9jb2wuc3RhcnQod29yaykpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMud29ya2VyLnRlcm1pbmF0ZSgpO1xuICB9XG5cbiAgc2VuZChjbWQ6IHN0cmluZykge1xuICAgIHRoaXMud29ya2VyLnBvc3RNZXNzYWdlKGNtZCk7XG4gIH1cbn1cblxuY2xhc3MgVGhyZWFkZWRXYXNtV29ya2VyIGV4dGVuZHMgQWJzdHJhY3RXb3JrZXIge1xuICBzdGF0aWMgZ2xvYmFsOiBQcm9taXNlPHtpbnN0YW5jZTogdW5rbm93biwgcHJvdG9jb2w6IFByb3RvY29sfT47XG5cbiAgcHJpdmF0ZSBpbnN0YW5jZT86IGFueTtcblxuICBib290KCk6IFByb21pc2U8UHJvdG9jb2w+IHtcbiAgICBpZiAoIVRocmVhZGVkV2FzbVdvcmtlci5nbG9iYWwpIFRocmVhZGVkV2FzbVdvcmtlci5nbG9iYWwgPSB3aW5kb3cubGljaGVzcy5sb2FkU2NyaXB0KHRoaXMudXJsLCB7c2FtZURvbWFpbjogdHJ1ZX0pLnRoZW4oKCkgPT4ge1xuICAgICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmluc3RhbmNlID0gd2luZG93WydTdG9ja2Zpc2gnXSgpLFxuICAgICAgICBwcm90b2NvbCA9IG5ldyBQcm90b2NvbCh0aGlzLnNlbmQuYmluZCh0aGlzKSwgdGhpcy53b3JrZXJPcHRzKSxcbiAgICAgICAgbGlzdGVuZXIgPSBwcm90b2NvbC5yZWNlaXZlZC5iaW5kKHByb3RvY29sKTtcbiAgICAgIGluc3RhbmNlLmFkZE1lc3NhZ2VMaXN0ZW5lcihsaXN0ZW5lcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbnN0YW5jZSwgLy8gYWx3YXlzIHdyYXAsIGluIHByb21pc2UgY29udGV4dCAoaHR0cHM6Ly9naXRodWIuY29tL2Vtc2NyaXB0ZW4tY29yZS9lbXNjcmlwdGVuL2lzc3Vlcy81ODIwKVxuICAgICAgICBwcm90b2NvbFxuICAgICAgfTtcbiAgICB9KTtcbiAgICByZXR1cm4gVGhyZWFkZWRXYXNtV29ya2VyLmdsb2JhbC50aGVuKGdsb2JhbCA9PiB7XG4gICAgICB0aGlzLmluc3RhbmNlID0gZ2xvYmFsLmluc3RhbmNlO1xuICAgICAgcmV0dXJuIGdsb2JhbC5wcm90b2NvbDtcbiAgICB9KTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgaWYgKFRocmVhZGVkV2FzbVdvcmtlci5nbG9iYWwpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdzdG9wcGluZyBzaW5nbGV0b24gd2FzbXggd29ya2VyIChpbnN0ZWFkIG9mIGRlc3Ryb3lpbmcpIC4uLicpO1xuICAgICAgdGhpcy5zdG9wKCkudGhlbigoKSA9PiBjb25zb2xlLmxvZygnLi4uIHN1Y2Nlc3NmdWxseSBzdG9wcGVkJykpO1xuICAgIH1cbiAgfVxuXG4gIHNlbmQoY21kOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5pbnN0YW5jZSkgdGhpcy5pbnN0YW5jZS5wb3N0TWVzc2FnZShjbWQpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQb29sIHtcbiAgcHJpdmF0ZSB3b3JrZXJzOiBBYnN0cmFjdFdvcmtlcltdID0gW107XG4gIHByaXZhdGUgdG9rZW4gPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcG9vbE9wdHM6IFBvb2xPcHRzLCBwcml2YXRlIHByb3RvY29sT3B0czogV29ya2VyT3B0cykgeyB9XG5cbiAgZ2V0V29ya2VyKCk6IFByb21pc2U8QWJzdHJhY3RXb3JrZXI+IHtcbiAgICB0aGlzLndhcm11cCgpO1xuXG4gICAgLy8gYnJpZWZseSB3YWl0IGFuZCBnaXZlIGEgY2hhbmNlIHRvIHJldXNlIHRoZSBjdXJyZW50IHdvcmtlclxuICAgIGNvbnN0IHdvcmtlciA9IG5ldyBQcm9taXNlPEFic3RyYWN0V29ya2VyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50V29ya2VyID0gdGhpcy53b3JrZXJzW3RoaXMudG9rZW5dO1xuICAgICAgY3VycmVudFdvcmtlci5zdG9wKCkudGhlbigoKSA9PiByZXNvbHZlKGN1cnJlbnRXb3JrZXIpKTtcbiAgICAgIHNldFRpbWVvdXQocmVqZWN0LCA1MCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gd29ya2VyLmNhdGNoKCgpID0+IHtcbiAgICAgIHRoaXMudG9rZW4gPSAodGhpcy50b2tlbiArIDEpICUgdGhpcy53b3JrZXJzLmxlbmd0aDtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy53b3JrZXJzW3RoaXMudG9rZW5dKTtcbiAgICB9KTtcbiAgfVxuXG4gIHdhcm11cCA9ICgpID0+IHtcbiAgICBpZiAodGhpcy53b3JrZXJzLmxlbmd0aCkgcmV0dXJuO1xuXG4gICAgaWYgKHRoaXMucG9vbE9wdHMudGVjaG5vbG9neSA9PSAnd2FzbXgnKVxuICAgICAgdGhpcy53b3JrZXJzLnB1c2gobmV3IFRocmVhZGVkV2FzbVdvcmtlcih0aGlzLnBvb2xPcHRzLndhc214LCB0aGlzLnBvb2xPcHRzLCB0aGlzLnByb3RvY29sT3B0cykpO1xuICAgIGVsc2Uge1xuICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gMjsgaSsrKVxuICAgICAgICB0aGlzLndvcmtlcnMucHVzaChuZXcgV2ViV29ya2VyKHRoaXMucG9vbE9wdHMudGVjaG5vbG9neSA9PSAnd2FzbScgPyB0aGlzLnBvb2xPcHRzLndhc20gOiB0aGlzLnBvb2xPcHRzLmFzbWpzLCB0aGlzLnBvb2xPcHRzLCB0aGlzLnByb3RvY29sT3B0cykpO1xuICAgIH1cbiAgfVxuXG4gIHN0b3AgPSAoKSA9PiB0aGlzLndvcmtlcnMuZm9yRWFjaCh3ID0+IHcuc3RvcCgpKTtcblxuICBkZXN0cm95ID0gKCkgPT4ge1xuICAgIHRoaXMuc3RvcCgpO1xuICAgIHRoaXMud29ya2Vycy5mb3JFYWNoKHcgPT4gdy5kZXN0cm95KCkpO1xuICB9O1xuXG4gIHN0YXJ0ID0gKHdvcms6IFdvcmspID0+IHtcbiAgICB3aW5kb3cubGljaGVzcy5zdG9yYWdlLmZpcmUoJ2NldmFsLnBvb2wuc3RhcnQnKTtcbiAgICB0aGlzLmdldFdvcmtlcigpLnRoZW4oZnVuY3Rpb24od29ya2VyKSB7XG4gICAgICB3b3JrZXIuc3RhcnQod29yayk7XG4gICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gd2luZG93LmxpY2hlc3MucmVsb2FkKCksIDEwMDAwKTtcbiAgICB9KTtcbiAgfTtcblxuICBpc0NvbXB1dGluZyA9ICgpID0+XG4gICAgISF0aGlzLndvcmtlcnMubGVuZ3RoICYmIHRoaXMud29ya2Vyc1t0aGlzLnRva2VuXS5pc0NvbXB1dGluZygpO1xuXG4gIGVuZ2luZU5hbWU6ICgpID0+IHN0cmluZyB8IHVuZGVmaW5lZCA9ICgpID0+XG4gICAgdGhpcy53b3JrZXJzW3RoaXMudG9rZW5dICYmIHRoaXMud29ya2Vyc1t0aGlzLnRva2VuXS5lbmdpbmVOYW1lKCk7XG59XG4iXX0=